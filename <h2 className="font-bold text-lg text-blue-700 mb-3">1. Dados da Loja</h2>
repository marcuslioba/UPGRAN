<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checklist Auditoria — Refatorado</title>

  <!-- Tailwind (prod CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- React 18 via CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- html2pdf for export -->
  <script src="https://unpkg.com/html2pdf.js@0.9.3/dist/html2pdf.bundle.min.js"></script>

  <style>
    body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .badge { display:inline-block; padding:2px 8px; border-radius:9999px; font-size:12px; font-weight:700; }
    .modal-backdrop{ background: rgba(0,0,0,0.5); position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; }
    .modal { background:white; border-radius:8px; padding:16px; max-width:90%; max-height:85%; overflow:auto; }
    @media print { .no-print { display:none !important; } }
  </style>
</head>
<body class="bg-gray-50">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    /* ---------- Helpers de LocalStorage ---------- */
    const LS = {
      get(key, fallback) {
        try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
      },
      set(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
      },
      remove(key) { localStorage.removeItem(key); }
    };

    /* ---------- Constantes ---------- */
    const LS_KEYS = {
      PERGUNTAS: 'checklist:perguntas',
      LOJA: 'checklist:loja',
      SETS_META: 'checklist:sets_meta',
      SET_PREFIX: 'checklist:set::',
      ULTIMO: 'checklist:ultimo'
    };

    /* ---------- Componentes ---------- */

    function App(){
      // Estado centralizado
      const [perguntas, setPerguntas] = useState(LS.get(LS_KEYS.PERGUNTAS, [
        { id:1, categoria:'Segurança', texto:'EPIs conferidos?', fotoObrigatoria:true },
        { id:2, categoria:'Operação', texto:'Equipamentos verificados?', fotoObrigatoria:false },
        { id:3, categoria:'Documentação', texto:'Documentos atualizados?', fotoObrigatoria:false },
      ]));
      const [loja, setLoja] = useState(LS.get(LS_KEYS.LOJA, { nome:'', endereco:'' }));
      const [avaliador, setAvaliador] = useState(LS.get("checklist:avaliador", ""));
useEffect(() => { LS.set("checklist:avaliador", avaliador); }, [avaliador]);
      const [setsMeta, setSetsMeta] = useState(LS.get(LS_KEYS.SETS_META, []));
      const [coords, setCoords] = useState(null);
      const [enderecoGPS, setEnderecoGPS] = useState('');
      const [gpsOk, setGpsOk] = useState(null);
      const [alvo, setAlvo] = useState(LS.get(LS_KEYS.ULTIMO, { lat:'', lon:'', raio:100 }));
      const [distancia, setDistancia] = useState(null);
      const [dentroArea, setDentroArea] = useState(false);

      // Execução
      const [respostas, setRespostas] = useState(LS.get(LS_KEYS.ULTIMO + ':respostas', {}));
      const [evidencias, setEvidencias] = useState(LS.get(LS_KEYS.ULTIMO + ':evidencias', {}));
      const [fase, setFase] = useState('inicial'); // inicial | execucao | relatorio
      const [inicioISO, setInicioISO] = useState(null);
      const [fimISO, setFimISO] = useState(null);

      // UI
      const [msg, setMsg] = useState(null);
      const [modalImg, setModalImg] = useState(null);

      // Sincronizar LocalStorage quando mudanças importantes ocorrerem
      useEffect(() => { LS.set(LS_KEYS.PERGUNTAS, perguntas); }, [perguntas]);
      useEffect(() => { LS.set(LS_KEYS.LOJA, loja); }, [loja]);
      useEffect(() => { LS.set(LS_KEYS.SETS_META, setsMeta); }, [setsMeta]);
      useEffect(() => { LS.set(LS_KEYS.ULTIMO, alvo); }, [alvo]);
      useEffect(() => { LS.set(LS_KEYS.ULTIMO + ':respostas', respostas); }, [respostas]);
      useEffect(() => { LS.set(LS_KEYS.ULTIMO + ':evidencias', evidencias); }, [evidencias]);

      // utilidades geo
      const toRad = (deg) => deg * Math.PI / 180;
      const haversine = (lat1, lon1, lat2, lon2) => {
        const R = 6371000;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      };

      useEffect(() => {
        if (coords && alvo.lat && alvo.lon) {
          const d = haversine(coords.latitude, coords.longitude, parseFloat(alvo.lat), parseFloat(alvo.lon));
          setDistancia(d);
          setDentroArea(d <= (parseFloat(alvo.raio) || 0));
        }
      }, [coords, alvo]);

      // agrupa por categoria (memo)
      const categorias = useMemo(() => {
        const map = new Map();
        for (const p of perguntas) {
          const key = p.categoria || 'Geral';
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(p);
        }
        return Array.from(map.entries()).sort((a,b) => a[0].localeCompare(b[0]));
      }, [perguntas]);

      // Iniciar checklist (valida requisitos)
      const podeIniciar = () => {
        if (!loja.nome.trim() || !loja.endereco.trim()) return false;
        if (!coords) return false;
        if (!dentroArea) return false;
        if (gpsOk !== true) return false;
        if (!perguntas.length) return false;
        return true;
      };

      const iniciar = () => {
        if (!podeIniciar()) {
          alert('Preencha dados da loja, capture GPS (dentro da área) e certifique que o endereço confere.');
          return;
        }
        setRespostas({});
        setEvidencias({});
        setInicioISO(new Date().toISOString());
        setFimISO(null);
        setFase('execucao');
        setMsg('Checklist iniciado');
      };

      const finalizar = () => {
        // valida respostas e evidencias obrigatórias
        for (const p of perguntas) {
          if (!respostas[p.id]) { alert('Responda todas as perguntas.'); return; }
          if (p.fotoObrigatoria && !evidencias[p.id]) { alert('Há evidências obrigatórias faltando.'); return; }
        }
        setFimISO(new Date().toISOString());
        setFase('relatorio');
      };

      const reiniciar = () => {
        setFase('inicial');
        setRespostas({});
        setEvidencias({});
        setInicioISO(null);
        setFimISO(null);
        setMsg(null);
      };

      // salvar conjunto
      const salvarSet = (name) => {
        if (!name || !name.trim()) { alert('Nome inválido'); return; }
        const key = LS_KEYS.SET_PREFIX + name.trim();
        LS.set(key, perguntas);
        const meta = [...setsMeta.filter(m => m.name !== name.trim()), { name: name.trim(), count: perguntas.length, updatedAt: new Date().toISOString() }];
        setSetsMeta(meta);
        setMsg('Conjunto salvo: ' + name.trim());
      };

      // carregar conjunto
      const carregarSet = (name) => {
        const key = LS_KEYS.SET_PREFIX + name;
        const lista = LS.get(key, null);
        if (!lista) { alert('Conjunto não encontrado'); return; }
        const mapped = lista.map((p,i) => ({ ...p, id: i+1 }));
        setPerguntas(mapped);
        setMsg('Conjunto "'+name+'" carregado');
      };

      // excluir conjunto
      const excluirSet = (name) => {
        if (!confirm('Excluir conjunto "'+name+'"?')) return;
        LS.remove(LS_KEYS.SET_PREFIX + name);
        setSetsMeta(setsMeta.filter(s => s.name !== name));
        setMsg('Conjunto excluído: ' + name);
      };

const exportarPDF = async () => {
  const element = document.getElementById('relatorio-root');
  if (!element) {
    alert('Relatório não encontrado na página.');
    return;
  }

  // Garante que as imagens estejam renderizadas
  await new Promise(resolve => setTimeout(resolve, 800));

  const opt = {
    margin: [0.3, 0.2, 0.3, 0.2],
    filename: `${loja.nome || "relatorio"}_${new Date().toISOString().split("T")[0]}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, scrollY: 0, logging: false },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  try {
    await html2pdf().set(opt).from(element).save();
  } catch (err) {
    console.error("Erro ao gerar PDF:", err);
    alert("Erro ao gerar PDF. Tente novamente.");
  }
};

      // UI de mensagens temporárias
      useEffect(() => {
        if (!msg) return;
        const t = setTimeout(() => setMsg(null), 3000);
        return () => clearTimeout(t);
      }, [msg]);

      return (
        <div className="min-h-screen p-4">
          <div className="max-w-6xl mx-auto">
            <header className="mb-6">
              <h1 className="text-2xl font-bold text-blue-700 flex items-center gap-3">
                <i className="fas fa-tasks text-xl"></i> Checklist Auditoria — Refatorado
              </h1>
              <p className="text-sm text-gray-600 mt-1">Modular, com persistência em LocalStorage e export PDF.</p>
            </header>

            {msg && <div className="mb-4 p-3 bg-green-50 text-green-700 rounded">{msg}</div>}

            {fase === 'inicial' && (
              <TelaInicial
                loja={loja} setLoja={setLoja}
                coords={coords} setCoords={setCoords}
                enderecoGPS={enderecoGPS} setEnderecoGPS={setEnderecoGPS}
                gpsOk={gpsOk} setGpsOk={setGpsOk}
                alvo={alvo} setAlvo={setAlvo}
                distancia={distancia} dentroArea={dentroArea}
                perguntas={perguntas} setPerguntas={setPerguntas}
                iniciar={iniciar} podeIniciar={podeIniciar}
                salvarSet={salvarSet} setsMeta={setsMeta} carregarSet={carregarSet} excluirSet={excluirSet}
                setMsg={setMsg}
              />
            )}

            {fase === 'execucao' && (
              <ExecucaoChecklist
                perguntas={perguntas} categorias={categorias}
                respostas={respostas} setRespostas={setRespostas}
                evidencias={evidencias} setEvidencias={setEvidencias}
                finalizar={finalizar}
                reiniciar={reiniciar}
                setModalImg={setModalImg}
              />
            )}

            {fase === 'relatorio' && (
<RelatorioFinal
  perguntas={perguntas} respostas={respostas} evidencias={evidencias}
  loja={loja} coords={coords} enderecoGPS={enderecoGPS}
  inicioISO={inicioISO} fimISO={fimISO}
  distancia={distancia} dentroArea={dentroArea}
  avaliador={avaliador}
  exportarPDF={exportarPDF} reiniciar={reiniciar}
/>
            )}

            {/* modal de imagem */}
            {modalImg && (
              <div className="modal-backdrop" onClick={() => setModalImg(null)}>
                <div className="modal" onClick={(e)=>e.stopPropagation()}>
                  <div className="flex justify-end">
                    <button onClick={() => setModalImg(null)} className="text-gray-600"><i className="fas fa-times"></i></button>
                  </div>
                  <img src={modalImg} alt="Evidencia" className="max-w-full" />
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ---------- Tela Inicial (dados, geo, perguntas) ---------- */
    function TelaInicial(props){
      const {
        loja, setLoja, coords, setCoords, enderecoGPS, setEnderecoGPS, gpsOk, setGpsOk,
        alvo, setAlvo, distancia, dentroArea,
        perguntas, setPerguntas, iniciar, podeIniciar,
        salvarSet, setsMeta, carregarSet, excluirSet, setMsg
      } = props;

      const [novaCategoria, setNovaCategoria] = useState('');
      const [novaPergunta, setNovaPergunta] = useState('');
      const [novaFotoObrigatoria, setNovaFotoObrigatoria] = useState(false);
      const [csvErro, setCsvErro] = useState('');
      const [nomeSet, setNomeSet] = useState('');
      const [gpsStatus, setGpsStatus] = useState('idle');

      useEffect(() => setCsvErro(''), [perguntas]);

      const adicionarPergunta = () => {
        if (!novaPergunta.trim()) return setMsg('Digite uma pergunta.');
        const nextId = perguntas.length ? Math.max(...perguntas.map(p=>p.id))+1 : 1;
        setPerguntas([...perguntas, { id: nextId, categoria: novaCategoria || 'Geral', texto: novaPergunta.trim(), fotoObrigatoria: !!novaFotoObrigatoria }]);
        setNovaCategoria(''); setNovaPergunta(''); setNovaFotoObrigatoria(false);
        setMsg('Pergunta adicionada');
      };

      const remover = (id) => {
        if (!confirm('Remover pergunta?')) return;
        setPerguntas(perguntas.filter(p=>p.id!==id));
      };

      const iniciarCaptura = () => {
        setGpsStatus('buscando');
        if (!('geolocation' in navigator)) {
          setGpsStatus('erro'); setMsg('Geolocalização não suportada'); return;
        }
        navigator.geolocation.getCurrentPosition(async (pos) => {
          setGpsStatus('ok');
          const { latitude, longitude, accuracy } = pos.coords;
          setCoords({ latitude, longitude, accuracy });
          // definimos alvo se estiver vazio
          if (!alvo.lat || !alvo.lon) setAlvo(prev => ({ ...prev, lat: latitude.toString(), lon: longitude.toString() }));

          // reverse geocoding (Nominatim)
          try {
            const url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=' + latitude + '&lon=' + longitude;
            const resp = await fetch(url, { headers:{ 'Accept-Language':'pt-BR' }});
            if (resp.ok) {
              const data = await resp.json();
              const display = data.display_name || '';
              setEnderecoGPS(display);
              // valida simples por tokens
              const ok = validarEndereco(display, loja.endereco || '');
              setGpsOk(ok);
            }
          } catch(e) {
            console.error(e);
            setMsg('Falha ao buscar endereço');
          }
        }, (err) => {
          setGpsStatus('erro'); setMsg('Erro ao obter localização: ' + (err.message || ''));
        }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
      };

      // normalizar e comparar tokens (mesma lógica do original)
      const normalizar = (s='') => (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[.,;:]/g,' ').replace(/\s+/g,' ').trim();
      const tokens = (s='') => normalizar(s).split(' ').filter(Boolean).filter(w => !/^\d+$/.test(w));
      const validarEndereco = (g, l) => {
        const a = new Set(tokens(l)); const b = new Set(tokens(g)); let inter=0;
        for (const t of a) if (b.has(t)) inter++;
        return inter >= 3;
      };

      // CSV
      const detectarDelim = (text) => {
        const p = text.split(/\r?\n/).slice(0,5).join('\n');
        const s1=(p.match(/;/g)||[]).length, s2=(p.match(/,/g)||[]).length, s3=(p.match(/\t/g)||[]).length;
        if (s1>=s2 && s1>=s3) return ';';
        if (s2>=s1 && s2>=s3) return ',';
        return '\t';
      };

      const parseBool = (v) => ['sim','yes','true','1'].includes(normalizar(v));
      const parseCSV = (text) => {
        const linhas = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        if (!linhas.length) return [];
        const delim = detectarDelim(text);
        const header = linhas[0].split(delim).map(c=>normalizar(c));
        const hasHeader = ['categoria','pergunta','perguntas','foto_obrigatoria','foto obrigatoria'].some(h=>header.includes(h));
        const out = [];
        if (hasHeader) {
          const idxCat = header.findIndex(h=>h==='categoria');
          const idxPerg = header.findIndex(h=>['pergunta','perguntas'].includes(h));
          const idxFoto = header.findIndex(h=>['foto_obrigatoria','foto obrigatoria'].includes(h));
          for (let i=1;i<linhas.length;i++){
            const cols = linhas[i].split(delim).map(c=>c.trim());
            const texto = idxPerg>=0 ? (cols[idxPerg]||'') : '';
            if (!texto) continue;
            const categoria = idxCat>=0 ? (cols[idxCat]||'Geral') : 'Geral';
            const foto = idxFoto>=0 ? parseBool(cols[idxFoto]||'nao') : false;
            out.push({ categoria, texto, fotoObrigatoria: !!foto });
          }
        } else {
          for (const l of linhas) out.push({ categoria:'Geral', texto:l, fotoObrigatoria:false });
        }
        // remove duplicados
        const uniq=[]; const seen=new Set();
        for (const p of out) {
          const key = normalizar(p.categoria + '__' + p.texto);
          if (!seen.has(key)) { seen.add(key); uniq.push(p); }
        }
        return uniq;
      };

      const handleCSV = (file) => {
        setCsvErro('');
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const dados = parseCSV(text);
            if (!dados.length) return setCsvErro('Nenhuma pergunta válida encontrada.');
            const mapped = dados.map((d,i) => ({ id: perguntas.length + i + 1, categoria:d.categoria, texto:d.texto, fotoObrigatoria:!!d.fotoObrigatoria }));
            setPerguntas([...perguntas, ...mapped]);
            setMsg('CSV importado com ' + dados.length + ' perguntas');
          } catch(err) {
            setCsvErro('Erro ao processar CSV: ' + (err.message||''));
          }
        };
        reader.readAsText(file,'utf-8');
      };

      return (
        <div className="bg-white rounded-lg shadow p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Dados da loja */}
            <div>
              <h2 className="font-bold text-lg text-blue-700 mb-3">1. Dados da Loja</h2>
              <label className="text-sm">Nome do Avaliador</label>
<input
  type="text"
  value={avaliador}
  onChange={(e) => setAvaliador(e.target.value)}
  className="w-full border rounded px-3 py-2 mb-2"
  placeholder="Ex.: João Silva"
/>

              <label className="text-sm">Nome</label>
              <input type="text" value={loja.nome} onChange={(e)=>setLoja({...loja, nome:e.target.value})}
                className="w-full border rounded px-3 py-2 mb-2" placeholder="Ex.: Loja Centro - Matriz"/>
              <label className="text-sm">Endereço</label>
              <input type="text" value={loja.endereco} onChange={(e)=>setLoja({...loja, endereco:e.target.value})}
                className="w-full border rounded px-3 py-2 mb-2" placeholder="Rua..., nº, Bairro, Cidade/UF"/>
              <div className="flex gap-2 items-center">
                <button onClick={()=>{ LS.set(LS_KEYS.LOJA, loja); setMsg('Dados da loja salvos'); }} className="bg-blue-500 text-white px-4 py-2 rounded">Salvar</button>
                <span className="text-xs text-gray-500">Os dados são salvos localmente.</span>
              </div>
            </div>

            {/* Geolocalização */}
            <div>
              <h2 className="font-bold text-lg text-indigo-700 mb-3">2. Localização GPS</h2>
              <div className="flex gap-2 mb-2">
                <button onClick={iniciarCaptura} className="bg-indigo-500 text-white px-4 py-2 rounded">Capturar Localização</button>
                <button onClick={() => { setCoords(null); setEnderecoGPS(''); setGpsOk(null); setMsg('Localização limpa'); }} className="bg-gray-200 px-3 py-2 rounded">Limpar</button>
              </div>
              {coords ? (
                <div className="text-sm text-gray-700">
                  <div><strong>Lat:</strong> {coords.latitude.toFixed(6)} <strong>Lon:</strong> {coords.longitude.toFixed(6)}</div>
                  {coords.accuracy && <div><strong>Precisão:</strong> ±{Math.round(coords.accuracy)} m</div>}
                  {enderecoGPS && <div className="break-words"><strong>Endereço GPS:</strong> {enderecoGPS}</div>}
                  <div className={gpsOk ? 'text-green-600 font-semibold' : gpsOk===false ? 'text-red-600 font-semibold' : 'text-gray-600'}>
                    {gpsOk === true ? '✓ Endereço confere' : gpsOk === false ? '✗ Endereço não confere' : 'Validando...'}
                  </div>
                  {distancia != null && <div className={dentroArea ? 'text-green-600' : 'text-red-600'}><strong>Distância:</strong> {Math.round(distancia)} m — {dentroArea ? 'Dentro' : 'Fora'}</div>}
                </div>
              ) : <div className="text-sm text-gray-500">Nenhuma localização capturada.</div>}
              <div className="mt-3">
                <label className="text-sm">Alvo (Lat)</label>
                <input value={alvo.lat} onChange={(e)=>setAlvo({...alvo, lat:e.target.value})} className="w-full border rounded px-2 py-1 mb-1"/>
                <label className="text-sm">Alvo (Lon)</label>
                <input value={alvo.lon} onChange={(e)=>setAlvo({...alvo, lon:e.target.value})} className="w-full border rounded px-2 py-1 mb-1"/>
                <label className="text-sm">Raio (m)</label>
                <input value={alvo.raio} onChange={(e)=>setAlvo({...alvo, raio:e.target.value})} className="w-full border rounded px-2 py-1"/>
              </div>
            </div>
          </div>

          {/* Perguntas */}
          <div className="mt-6 bg-purple-50 p-4 rounded">
            <h2 className="font-bold text-lg text-purple-700 mb-3">3. Gerenciar Perguntas</h2>
            <div className="grid grid-cols-1 md:grid-cols-12 gap-2">
              <input className="md:col-span-3 px-3 py-2 border rounded" placeholder="Categoria" value={novaCategoria} onChange={e=>setNovaCategoria(e.target.value)} />
              <input className="md:col-span-7 px-3 py-2 border rounded" placeholder="Pergunta..." value={novaPergunta} onChange={e=>setNovaPergunta(e.target.value)} onKeyDown={(e)=>{ if(e.key==='Enter') adicionarPergunta(); }} />
              <label className="md:col-span-2 flex items-center gap-2 px-2">
                <input type="checkbox" checked={novaFotoObrigatoria} onChange={e=>setNovaFotoObrigatoria(e.target.checked)} /> Foto obrigatória
              </label>
            </div>
            <div className="mt-3 flex gap-2">
              <button onClick={adicionarPergunta} className="bg-purple-500 text-white px-4 py-2 rounded">Adicionar</button>
              <input type="file" accept=".csv" onChange={e=>handleCSV(e.target.files[0])} className="text-sm" />
              <button onClick={()=>{
                const linhas=['categoria;pergunta;foto_obrigatoria','Segurança;EPIs conferidos?;sim','Operação;Equipamentos verificados?;nao'];
                const blob=new Blob([linhas.join('\n')],{type:'text/csv'}), url=URL.createObjectURL(blob);
                const a=document.createElement('a'); a.href=url; a.download='modelo.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
              }} className="text-purple-600 underline text-sm">Baixar modelo CSV</button>
            </div>

            {csvErro && <div className="mt-2 text-red-600">{csvErro}</div>}

            <div className="mt-4 space-y-2">
              {perguntas.map(p => (
                <div key={p.id} className="bg-white p-3 rounded flex items-center gap-3 shadow">
                  <span className="badge bg-gray-100 text-gray-700">{p.categoria}</span>
                  <div className="flex-1 text-sm">{p.texto}</div>
                  {p.fotoObrigatoria && <span className="badge bg-yellow-100 text-yellow-700"><i className="fas fa-camera mr-1"></i></span>}
                  <button onClick={()=>{ const novo=perguntas.map(x=> x.id===p.id? {...x, texto: prompt('Editar pergunta', x.texto) || x.texto}:x); setPerguntas(novo); }} className="text-blue-600"><i className="fas fa-edit"></i></button>
                  <button onClick={()=>remover(p.id)} className="text-red-600"><i className="fas fa-trash"></i></button>
                </div>
              ))}
            </div>
          </div>

          {/* Conjuntos salvos */}
          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="bg-white p-3 rounded shadow">
              <div className="font-semibold">Salvar conjunto</div>
              <div className="flex gap-2 mt-2">
                <input className="flex-1 border rounded px-2 py-1" placeholder="Nome do conjunto" value={nomeSet} onChange={e=>setNomeSet(e.target.value)} />
                <button onClick={()=>{ salvarSet(nomeSet); setNomeSet(''); }} className="bg-green-500 text-white px-3 py-1 rounded">Salvar</button>
              </div>
              <div className="text-xs text-gray-500 mt-2">Conjuntos ficam no seu navegador.</div>
            </div>

            <div className="bg-white p-3 rounded shadow">
              <div className="font-semibold">Carregar / Excluir conjunto</div>
              <div className="flex gap-2 mt-2">
                <select className="flex-1 border rounded px-2 py-1" id="select-conjuntos">
                  <option value="">Selecione um conjunto</option>
                  {setsMeta.sort((a,b)=>a.name.localeCompare(b.name)).map(s => <option key={s.name} value={s.name}>{s.name} ({s.count})</option>)}
                </select>
                <button onClick={()=>{
                  const sel=document.getElementById('select-conjuntos').value;
                  if(!sel) return alert('Selecione um conjunto'); carregarSet(sel);
                }} className="bg-blue-500 text-white px-3 py-1 rounded">Carregar</button>
                <button onClick={()=>{
                  const sel=document.getElementById('select-conjuntos').value;
                  if(!sel) return alert('Selecione um conjunto'); excluirSet(sel);
                }} className="bg-red-500 text-white px-3 py-1 rounded">Excluir</button>
              </div>
            </div>
          </div>

          <div className="mt-6 flex gap-3">
            <button onClick={iniciar} disabled={!podeIniciar()} className={`flex-1 py-3 rounded font-bold ${podeIniciar() ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600 cursor-not-allowed'}`}>Iniciar Checklist</button>
            <button onClick={()=>{ if(confirm('Limpar todas as perguntas?')){ setPerguntas([]); setMsg('Perguntas limpas'); } }} className="py-3 px-4 rounded bg-gray-200">Limpar</button>
          </div>
        </div>
      );
    }

    /* ---------- Execução do checklist ---------- */
    function ExecucaoChecklist({ perguntas, categorias, respostas, setRespostas, evidencias, setEvidencias, finalizar, reiniciar, setModalImg }){
      const handleResposta = (id, val) => setRespostas({ ...respostas, [id]: val });
      const handleUpload = (id, file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => setEvidencias(prev => ({ ...prev, [id]: e.target.result }));
        reader.readAsDataURL(file);
      };
      const todasRespondidas = perguntas.every(p => respuestasOu(respostas[p.id]));
      const evidenciasOK = perguntas.every(p => (!p.fotoObrigatoria) || evidencias[p.id]);

      function respuestasOu(v){ return !!v; }

      return (
        <div className="bg-white rounded shadow p-6">
          <h2 className="font-bold text-xl text-purple-700 mb-4">Checklist em andamento</h2>
          <div className="space-y-4">
            {categorias.map(([cat, itens]) => (
              <div key={cat} className="border rounded">
                <div className="bg-gray-100 px-4 py-2 font-semibold">{cat}</div>
                <div className="p-3 space-y-3">
                  {itens.map(p => (
                    <div key={p.id} className="bg-gray-50 p-3 rounded flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                      <div>
                        <div className="font-semibold">{p.texto}</div>
                        {p.fotoObrigatoria && <div className="text-xs text-yellow-700 mt-1">Foto obrigatória</div>}
                      </div>
                      <div className="flex items-center gap-3">
                        <button onClick={()=>handleResposta(p.id,'sim')} className={`${respostas[p.id]==='sim' ? 'bg-green-600 text-white' : 'bg-gray-200'} px-3 py-2 rounded`}>SIM</button>
                        <button onClick={()=>handleResposta(p.id,'nao')} className={`${respostas[p.id]==='nao' ? 'bg-red-600 text-white' : 'bg-gray-200'} px-3 py-2 rounded`}>NÃO</button>

                        <div className="flex items-center gap-2">
                          <input type="file" accept="image/*" capture="environment" onChange={(e)=>handleUpload(p.id, e.target.files[0])} />
                          {evidencias[p.id] && (
                            <div className="flex items-center gap-2">
                              <img src={evidencias[p.id]} alt="evid" className="h-12 w-12 object-cover rounded border cursor-pointer" onClick={()=>setModalImg(evidencias[p.id])} />
                              <button onClick={()=>{ const copy={...evidencias}; delete copy[p.id]; setEvidencias(copy); }} className="text-sm text-red-600">Remover</button>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="mt-6 flex gap-3">
            <button onClick={finalizar} className={`flex-1 py-3 rounded font-bold ${todasRespondidas && evidenciasOK ? 'bg-purple-600 text-white' : 'bg-gray-300 text-gray-600 cursor-not-allowed'}`}>Finalizar e Gerar Relatório</button>
            <button onClick={reiniciar} className="py-3 px-4 rounded bg-gray-200">Cancelar</button>
          </div>
        </div>
      );
    }

    /* ---------- Relatório Final ---------- */
    function RelatorioFinal({ perguntas, respostas, evidencias, loja, coords, enderecoGPS, inicioISO, fimISO, distancia, dentroArea, exportarPDF, reiniciar }){
      const nota = (() => {
        const total = perguntas.length;
        const pos = perguntas.filter(p => respostas[p.id] === 'sim').length;
        return total ? ((pos/total)*10).toFixed(1) : '0.0';
      })();

      const duracaoHumana = (iso1, iso2) => {
        if (!iso1 || !iso2) return '';
        const ms = new Date(iso2) - new Date(iso1);
        if (ms < 0) return '';
        const s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), seg=s%60;
        return [h? h+'h':null, (m||h)? m+'m':null, seg+'s'].filter(Boolean).join(' ');
      };

      return (
        <div className="bg-white rounded shadow p-6">
          <div id="relatorio-root">
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-bold text-2xl text-green-600">Relatório do Checklist</h2>
              <div className="text-right text-sm text-gray-600">
                <div><strong>{loja.nome}</strong></div>
                <div>{loja.endereco}</div>
                {avaliador && <div><strong>Avaliador:</strong> {avaliador}</div>}

              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div><strong>Início:</strong> {inicioISO ? new Date(inicioISO).toLocaleString('pt-BR') : '-'}</div>
                <div><strong>Término:</strong> {fimISO ? new Date(fimISO).toLocaleString('pt-BR') : '-'}</div>
                <div><strong>Duração:</strong> {duracaoHumana(inicioISO, fimISO)}</div>
              </div>
              <div>
                {coords && (
                  <>
                    <div><strong>Lat:</strong> {coords.latitude.toFixed(6)} <strong>Lon:</strong> {coords.longitude.toFixed(6)}</div>
                    {coords.accuracy && <div><strong>Precisão:</strong> ±{Math.round(coords.accuracy)} m</div>}
                    {enderecoGPS && <div className="break-words"><strong>Endereço GPS:</strong> {enderecoGPS}</div>}
                    {distancia != null && <div><strong>Distância ao alvo:</strong> {Math.round(distancia)} m — {dentroArea ? 'Dentro da área' : 'Fora da área'}</div>}
                  </>
                )}
              </div>
            </div>

            <div className="bg-green-50 p-4 rounded mb-4 text-center">
              <div className="text-4xl font-bold text-green-600">{nota}</div>
              <div className="text-sm text-gray-600">Nota (0-10)</div>
            </div>

            <div className="space-y-3">
              {Object.entries(groupByCategory(perguntas)).map(([cat, itens]) => (
                <div key={cat} className="border rounded">
                  <div className="bg-gray-100 px-3 py-2 font-semibold">{cat}</div>
                  <div className="p-3 space-y-2">
                    {itens.map(p => (
                      <div key={p.id} className="flex items-center justify-between bg-gray-50 p-2 rounded">
                        <div>
                          <div className="font-semibold">{p.texto}</div>
                          <div className={respostas[p.id] === 'sim' ? 'text-green-700 font-bold' : 'text-red-700 font-bold'}>{respostas[p.id] === 'sim' ? '✓ SIM' : '✗ NÃO'}</div>
                        </div>
                        <div className="w-32 text-center">
                          {evidencias[p.id] ? <img src={evidencias[p.id]} className="w-32 h-20 object-cover rounded border" alt="evid" /> : <div className="text-xs text-gray-500">Sem evidência</div>}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>

<div className="mt-4 flex gap-3 no-print">
  <button
    onClick={exportarPDF}
    className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition"
  >
    <i className="fas fa-file-pdf mr-2"></i>Salvar em PDF
  </button>
  <button
    onClick={reiniciar}
    className="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 transition"
  >
    <i className="fas fa-redo mr-2"></i>Novo Checklist
  </button>
</div>
        </div>
      );
    }

    /* ---------- Utilities ---------- */
    function groupByCategory(perguntas){
      const map = {};
      for (const p of perguntas) {
        const key = p.categoria || 'Geral';
        if (!map[key]) map[key] = [];
        map[key].push(p);
      }
      return map;
    }

    /* ---------- Render ---------- */
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>



