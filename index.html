<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checklist Auditoria</title>

  <!-- Tailwind + FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- React -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --brand-primary: #2563eb;
      --brand-accent: #16a34a;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .btn {
      @apply px-4 py-2 rounded-lg font-semibold transition shadow-sm;
    }
    .btn-primary {
      background: var(--brand-primary);
      color: #fff;
    }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-accent {
      background: var(--brand-accent);
      color: #fff;
    }
    .btn-accent:hover { filter: brightness(1.1); }
    .btn-ghost {
      @apply bg-white border border-gray-300 text-gray-700;
    }
    .btn-ghost:hover { @apply bg-gray-50; }
    .badge {
      @apply inline-block px-2 py-0.5 rounded-full text-xs font-bold;
    }
    .card {
      @apply bg-white rounded-xl shadow-sm border border-gray-100;
    }
    .section-title {
      @apply text-xl font-bold mb-4;
      color: var(--brand-primary);
    }
    .tab-btn {
      @apply flex flex-col items-center justify-center gap-2 px-6 py-4 rounded-xl transition cursor-pointer;
      border: 2px solid transparent;
    }
    .tab-btn:hover {
      @apply bg-gray-50;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-accent) 100%);
      color: white;
      border-color: transparent;
    }
    .tab-btn .icon {
      @apply text-3xl;
    }
    .tab-btn .label {
      @apply text-sm font-semibold;
    }
    @media print {
      .no-print { display: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Utils
    const uid = () => Math.random().toString(36).slice(2, 10);
    const normalize = (s) => (s || '')
      .toString().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[.,;:]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    const fmtDateTime = (iso) => {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString('pt-BR');
    };
    const fmtDate = (iso) => {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleDateString('pt-BR');
    };
    const humanDuration = (ms) => {
      if (!ms || ms < 0) return '';
      const s = Math.floor(ms / 1000);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const seg = s % 60;
      return [h ? h + 'h' : null, (m || h) ? m + 'm' : null, seg + 's'].filter(Boolean).join(' ');
    };
    const toRad = (deg) => (deg * Math.PI) / 180;
    const haversineMeters = (lat1, lon1, lat2, lon2) => {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    };

    // Storage keys
    const LS_SETS_META = 'checklist_sets_meta';
    const LS_SET_PREFIX = 'checklist_set::';
    const LS_STORE_NAME = 'loja_nome';
    const LS_STORE_ADDR = 'loja_endereco';
    const LS_BRAND = 'brand_prefs';
    const LS_HISTORY = 'checklist_history';

    function App() {
      // Aba ativa
      const [abaAtiva, setAbaAtiva] = useState('inicio'); // inicio, perguntas, loja, personalizacao, historico

      // Marca
      const [brandPrimary, setBrandPrimary] = useState('#2563eb');
      const [brandAccent, setBrandAccent] = useState('#16a34a');
      const [brandLogo, setBrandLogo] = useState('');

      // Loja
      const [lojaNome, setLojaNome] = useState('');
      const [lojaEndereco, setLojaEndereco] = useState('');

      // Perguntas
      const [perguntas, setPerguntas] = useState([
        { id: 1, categoria: 'Segurança', texto: 'EPIs conferidos?', fotoObrigatoria: true },
        { id: 2, categoria: 'Operação', texto: 'Equipamentos verificados?', fotoObrigatoria: false },
        { id: 3, categoria: 'Documentação', texto: 'Documentos atualizados?', fotoObrigatoria: false },
      ]);
      const [novaPergunta, setNovaPergunta] = useState('');
      const [novaCategoria, setNovaCategoria] = useState('');
      const [novaFotoObrigatoria, setNovaFotoObrigatoria] = useState(false);
      const [editandoId, setEditandoId] = useState(null);
      const [textoEdicao, setTextoEdicao] = useState('');
      const [categoriaEdicao, setCategoriaEdicao] = useState('');
      const [fotoObrigatoriaEdicao, setFotoObrigatoriaEdicao] = useState(false);

      // CSV
      const [uploadErro, setUploadErro] = useState('');

      // Sets de perguntas
      const [nomeSet, setNomeSet] = useState('');
      const [setsSalvos, setSetsSalvos] = useState([]);
      const [setSelecionado, setSetSelecionado] = useState('');

      // Geo
      const [geoStatus, setGeoStatus] = useState('idle');
      const [coords, setCoords] = useState(null);
      const [enderecoGPS, setEnderecoGPS] = useState('');
      const [geoErro, setGeoErro] = useState('');
      const [alvoLat, setAlvoLat] = useState('');
      const [alvoLon, setAlvoLon] = useState('');
      const [alvoRaio, setAlvoRaio] = useState(100);
      const [distancia, setDistancia] = useState(null);
      const [dentroDaArea, setDentroDaArea] = useState(false);
      const [gpsConfereEndereco, setGpsConfereEndereco] = useState(null);
      const [gpsValidando, setGpsValidando] = useState(false);

      // Fluxo checklist
      const [checklistIniciado, setChecklistIniciado] = useState(false);
      const [checklistFinalizado, setChecklistFinalizado] = useState(false);
      const [respostas, setRespostas] = useState({});
      const [evidencias, setEvidencias] = useState({});
      const [inicioISO, setInicioISO] = useState(null);
      const [fimISO, setFimISO] = useState(null);

      // Histórico
      const [historico, setHistorico] = useState([]);
      const [whatsNumeroPadrao, setWhatsNumeroPadrao] = useState('');

      // Aplicar tema
      useEffect(() => {
        document.documentElement.style.setProperty('--brand-primary', brandPrimary || '#2563eb');
        document.documentElement.style.setProperty('--brand-accent', brandAccent || '#16a34a');
      }, [brandPrimary, brandAccent]);

      // Carregamento inicial
      useEffect(() => {
        setLojaNome(localStorage.getItem(LS_STORE_NAME) || '');
        setLojaEndereco(localStorage.getItem(LS_STORE_ADDR) || '');
        try {
          setSetsSalvos(JSON.parse(localStorage.getItem(LS_SETS_META) || '[]'));
        } catch { setSetsSalvos([]); }
        try {
          const b = JSON.parse(localStorage.getItem(LS_BRAND) || 'null');
          if (b) {
            if (b.primary) setBrandPrimary(b.primary);
            if (b.accent) setBrandAccent(b.accent);
            if (b.logoDataUrl) setBrandLogo(b.logoDataUrl);
          }
        } catch {}
        try {
          setHistorico(JSON.parse(localStorage.getItem(LS_HISTORY) || '[]'));
        } catch { setHistorico([]); }
      }, []);

      // Persistir marca
      const salvarMarca = (obj) => {
        const novo = { primary: brandPrimary, accent: brandAccent, logoDataUrl: brandLogo, ...obj };
        localStorage.setItem(LS_BRAND, JSON.stringify(novo));
      };

      // Persistir loja
      const salvarLojaNome = (v) => {
        setLojaNome(v);
        localStorage.setItem(LS_STORE_NAME, v);
      };
      const salvarLojaEndereco = (v) => {
        setLojaEndereco(v);
        localStorage.setItem(LS_STORE_ADDR, v);
      };

      // Sets perguntas
      const carregarMeta = () => {
        try { return JSON.parse(localStorage.getItem(LS_SETS_META) || '[]'); } catch { return []; }
      };
      const salvarMeta = (meta) => {
        localStorage.setItem(LS_SETS_META, JSON.stringify(meta));
      };
      const salvarSetLocal = (nome, listaPerguntas) => {
        if (!nome || !listaPerguntas?.length) return;
        localStorage.setItem(LS_SET_PREFIX + nome, JSON.stringify(listaPerguntas));
        const meta = carregarMeta();
        const idx = meta.findIndex(m => m.name === nome);
        const item = { name: nome, count: listaPerguntas.length, updatedAt: new Date().toISOString() };
        if (idx >= 0) meta[idx] = item; else meta.push(item);
        salvarMeta(meta);
        setSetsSalvos(meta);
      };
      const carregarSetLocal = (nome) => {
        try { return JSON.parse(localStorage.getItem(LS_SET_PREFIX + nome) || 'null'); } catch { return null; }
      };
      const excluirSetLocal = (nome) => {
        localStorage.removeItem(LS_SET_PREFIX + nome);
        const meta = carregarMeta().filter(m => m.name !== nome);
        salvarMeta(meta);
        setSetsSalvos(meta);
      };

      // Agrupar categorias
      const categorias = useMemo(() => {
        const map = new Map();
        for (const p of perguntas) {
          const c = p.categoria || 'Geral';
          if (!map.has(c)) map.set(c, []);
          map.get(c).push(p);
        }
        return Array.from(map.entries()).sort((a,b) => a[0].localeCompare(b[0]));
      }, [perguntas]);

      // Edição/adicionar perguntas
      const proxId = useMemo(() => (perguntas.length ? Math.max(...perguntas.map(p => p.id)) + 1 : 1), [perguntas]);
      const adicionarPergunta = () => {
        if (!novaPergunta.trim()) return;
        const cat = (novaCategoria || 'Geral').trim();
        setPerguntas(prev => [...prev, { id: proxId, categoria: cat, texto: novaPergunta.trim(), fotoObrigatoria: !!novaFotoObrigatoria }]);
        setNovaCategoria(''); setNovaPergunta(''); setNovaFotoObrigatoria(false);
      };
      const iniciarEdicao = (id) => {
        const p = perguntas.find(x => x.id === id);
        if (!p) return;
        setEditandoId(id);
        setCategoriaEdicao(p.categoria);
        setTextoEdicao(p.texto);
        setFotoObrigatoriaEdicao(!!p.fotoObrigatoria);
      };
      const salvarEdicao = () => {
        if (editandoId == null) return;
        setPerguntas(prev => prev.map(p => p.id === editandoId ? ({
          ...p,
          categoria: (categoriaEdicao || 'Geral').trim(),
          texto: (textoEdicao || p.texto).trim(),
          fotoObrigatoria: !!fotoObrigatoriaEdicao
        }) : p));
        setEditandoId(null);
        setCategoriaEdicao('');
        setTextoEdicao('');
        setFotoObrigatoriaEdicao(false);
      };
      const removerPergunta = (id) => setPerguntas(perguntas.filter(p => p.id !== id));

      // CSV
      const detectarDelim = (text) => {
        const head = text.split(/\r?\n/).slice(0, 5).join('\n');
        const c1 = (head.match(/;/g) || []).length;
        const c2 = (head.match(/,/g) || []).length;
        const c3 = (head.match(/\t/g) || []).length;
        if (c1 >= c2 && c1 >= c3) return ';';
        if (c2 >= c1 && c2 >= c3) return ',';
        return '\t';
      };
      const parseBoolLoose = (v) => ['sim','yes','true','1'].includes(normalize(v));
      const parseCSVToPerguntas = (text) => {
        const linhas = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        if (!linhas.length) return [];
        const delim = detectarDelim(text);
        const header = linhas[0].split(delim).map(c => normalize(c));
        const hasHeader = ['categoria','pergunta','perguntas','foto_obrigatoria','foto obrigatoria','foto-obrigatoria','foto obrigatoria?'].some(h => header.includes(h));
        const out = [];
        if (hasHeader) {
          const idxCategoria = header.findIndex(h => h === 'categoria');
          const idxPergunta = header.findIndex(h => ['pergunta','perguntas'].includes(h));
          const idxFoto = header.findIndex(h => ['foto_obrigatoria','foto obrigatoria','foto-obrigatoria','foto obrigatoria?'].includes(h));
          for (let i = 1; i < linhas.length; i++) {
            const cols = linhas[i].split(delim).map(c => c.trim());
            const texto = idxPergunta >= 0 ? (cols[idxPergunta] || '') : '';
            if (!texto) continue;
            const categoria = idxCategoria >= 0 ? (cols[idxCategoria] || 'Geral') : 'Geral';
            const fotoObrigatoria = idxFoto >= 0 ? parseBoolLoose(cols[idxFoto] || 'não') : false;
            out.push({ categoria, texto, fotoObrigatoria });
          }
        } else {
          for (const l of linhas) out.push({ categoria: 'Geral', texto: l, fotoObrigatoria: false });
        }
        const seen = new Set(); const uniq = [];
        for (const p of out) {
          const key = normalize((p.categoria||'Geral') + '::' + p.texto);
          if (!seen.has(key)) { seen.add(key); uniq.push(p); }
        }
        return uniq;
      };
      const handleArquivoCSV = (file) => {
        setUploadErro('');
        if (!file) return;
        if (!file.name.toLowerCase().endsWith('.csv')) {
          setUploadErro('Formato não suportado. Use CSV (.csv).');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const dados = parseCSVToPerguntas(e.target.result);
            if (!dados.length) { setUploadErro('Nenhuma pergunta válida encontrada.'); return; }
            const novos = dados.map((d, i) => ({ id: i+1, categoria: d.categoria || 'Geral', texto: d.texto, fotoObrigatoria: !!d.fotoObrigatoria }));
            setPerguntas(novos);
            setRespostas({});
            setEvidencias({});
          } catch (err) {
            setUploadErro('Erro processando CSV: ' + err.message);
          }
        };
        reader.readAsText(file, 'utf-8');
      };
      const baixarModeloCSV = () => {
        const linhas = [
          'categoria;pergunta;foto_obrigatoria',
          'Segurança;EPIs conferidos?;sim',
          'Operação;Equipamentos verificados?;nao',
          'Documentação;Documentos atualizados?;nao'
        ];
        const blob = new Blob([linhas.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'modelo_perguntas_checklist.csv';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Geo + validação endereço
      const tokensEndereco = (s) => normalize(s).split(' ').filter(w => w && !/^\d{1,2}$/.test(w));
      const enderecoCoincide = (loja, gps) => {
        const a = new Set(tokensEndereco(loja));
        const b = new Set(tokensEndereco(gps));
        let inter = 0; for (const t of a) if (b.has(t)) inter++;
        return inter >= 3;
      };
      const validarEnderecoGPS = (endGPS, endLoja) => {
        setGpsValidando(true);
        try { setGpsConfereEndereco(enderecoCoincide(endLoja, endGPS)); }
        finally { setGpsValidando(false); }
      };
      const capturarLocalizacao = () => {
        setGeoErro('');
        if (!('geolocation' in navigator)) { setGeoStatus('erro'); setGeoErro('Geolocalização não suportada.'); return; }
        setGeoStatus('buscando');
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const c = { latitude, longitude, accuracy };
          setCoords(c);
          setGeoStatus('ok');
          if (!alvoLat || !alvoLon) {
            setAlvoLat(String(latitude)); setAlvoLon(String(longitude)); setDistancia(0); setDentroDaArea(true);
          } else {
            const d = haversineMeters(latitude, longitude, parseFloat(alvoLat), parseFloat(alvoLon));
            setDistancia(d); setDentroDaArea(d <= (parseFloat(alvoRaio) || 0));
          }
          try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
            const resp = await fetch(url, { headers: { 'Accept-Language': 'pt-BR' } });
            if (resp.ok) {
              const data = await resp.json();
              const end = data.display_name || '';
              setEnderecoGPS(end);
              if (lojaEndereco.trim()) validarEnderecoGPS(end, lojaEndereco);
            }
          } catch (e) {}
        }, (err) => {
          setGeoStatus('erro'); setGeoErro(err.message || 'Falha ao obter localização.');
        }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
      };

      // Evidências
      const handleEvidenciaUpload = (id, file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => setEvidencias(prev => ({ ...prev, [id]: e.target.result }));
        reader.readAsDataURL(file);
      };

      // Fluxo checklist
      const responder = (id, v) => setRespostas(prev => ({ ...prev, [id]: v }));
      const requisitosParaIniciar = () =>
        lojaNome.trim() && lojaEndereco.trim() && coords && dentroDaArea && gpsConfereEndereco === true && perguntas.length > 0;
      const iniciarChecklist = () => {
        if (!requisitosParaIniciar()) {
          alert('Para iniciar: loja preenchida, GPS ok, dentro da área e endereço GPS deve coincidir.');
          return;
        }
        setChecklistIniciado(true);
        setInicioISO(new Date().toISOString());
        setFimISO(null);
      };
      const todasRespondidas = perguntas.every(p => respostas[p.id]);
      const fotosOk = perguntas.every(p => p.fotoObrigatoria ? !!evidencias[p.id] : true);
      const calcularNota = () => {
        const total = perguntas.length;
        const pos = perguntas.filter(p => respostas[p.id] === 'sim').length;
        return total ? ((pos / total) * 10).toFixed(1) : '0.0';
      };

      // Histórico: salvar no fim, com WhatsApp
      const finalizarChecklist = async () => {
        if (!todasRespondidas) { alert('Responda todas as perguntas.'); return; }
        if (!fotosOk) { alert('Há itens com foto obrigatória sem evidência.'); return; }
        const fim = new Date().toISOString();
        setFimISO(fim);

        let numero = prompt('Informe o número (WhatsApp) para enviar o relatório, com DDI. Ex.: 55XXXXXXXXXXX', whatsNumeroPadrao || '');
        if (numero) {
          numero = numero.replace(/\D/g, '');
          setWhatsNumeroPadrao(numero);
        }

        const nota = calcularNota();
        const tipoChecklist = setSelecionado || 'Checklist Atual';
        const historicoItem = {
          id: uid(),
          lojaNome,
          lojaEndereco,
          tipoChecklist,
          inicioISO,
          fimISO: fim,
          nota,
          perguntas,
          respostas,
          evidencias,
          coords,
          enderecoGPS,
          distancia,
          dentroDaArea,
          createdAt: new Date().toISOString(),
        };

        const novoHist = [historicoItem, ...historico].slice(0, 50);
        setHistorico(novoHist);
        localStorage.setItem(LS_HISTORY, JSON.stringify(novoHist));

        if (numero) {
          const resumo = [
            `Checklist: ${tipoChecklist}`,
            `Loja: ${lojaNome}`,
            `Endereço: ${lojaEndereco}`,
            `Início: ${fmtDateTime(inicioISO)}`,
            `Término: ${fmtDateTime(fim)}`,
            `Nota: ${nota}`,
          ].join('\n');
          const url = `https://wa.me/${numero}?text=${encodeURIComponent(resumo)}`;
          window.open(url, '_blank');
        }

        setChecklistFinalizado(true);
      };

      const reiniciar = () => {
        setChecklistIniciado(false);
        setChecklistFinalizado(false);
        setRespostas({});
        setEvidencias({});
        setCoords(null);
        setEnderecoGPS('');
        setGeoStatus('idle');
        setGeoErro('');
        setDistancia(null);
        setDentroDaArea(false);
        setGpsConfereEndereco(null);
        setInicioISO(null);
        setFimISO(null);
      };

      // Histórico por loja/tipo
      const historicoDaLojaEPorTipo = useMemo(() => {
        if (!lojaNome) return [];
        const tipoAtual = setSelecionado || 'Checklist Atual';
        return historico
          .filter(h => h.lojaNome === lojaNome && h.tipoChecklist === tipoAtual)
          .slice(0, 5);
      }, [historico, lojaNome, setSelecionado]);

      // ========== RENDERIZAÇÃO ==========

      // Relatório final
      if (checklistFinalizado) {
        const nota = calcularNota();
        const total = perguntas.length;
        const pos = perguntas.filter(p => respostas[p.id] === 'sim').length;
        const dur = inicioISO && fimISO ? humanDuration(new Date(fimISO) - new Date(inicioISO)) : '';

        return (
          <div className="max-w-6xl mx-auto p-6">
            <div className="flex items-center gap-4 mb-6 no-print">
              {brandLogo && <img src={brandLogo} alt="logo" className="h-12 w-auto"/>}
              <h1 className="text-3xl font-bold" style={{color: 'var(--brand-primary)'}}>Relatório do Checklist</h1>
            </div>

            <div className="grid lg:grid-cols-3 gap-6 mb-6">
              <div className="card p-6 lg:col-span-2">
                <div className="section-title">Informações</div>
                <div className="grid sm:grid-cols-2 gap-4 text-sm">
                  <div><span className="font-semibold">Loja:</span> {lojaNome}</div>
                  <div><span className="font-semibold">Tipo:</span> {setSelecionado || 'Checklist Atual'}</div>
                  <div className="sm:col-span-2"><span className="font-semibold">Endereço:</span> {lojaEndereco}</div>
                  <div><span className="font-semibold">Início:</span> {fmtDateTime(inicioISO)}</div>
                  <div><span className="font-semibold">Término:</span> {fmtDateTime(fimISO)}</div>
                  <div><span className="font-semibold">Duração:</span> {dur}</div>
                </div>
              </div>
              <div className="card p-6 flex flex-col items-center justify-center bg-gradient-to-br from-green-50 to-green-100">
                <div className="text-6xl font-bold" style={{color:'var(--brand-accent)'}}>{nota}</div>
                <div className="text-sm text-gray-700 mt-2">Nota Final</div>
                <div className="text-xs text-gray-600">{pos} de {total} respostas SIM</div>
              </div>
            </div>

            <div className="card p-6 mb-6">
              <div className="section-title">Respostas por Categoria</div>
              <div className="space-y-6">
                {categorias.map(([cat, itens]) => (
                  <div key={cat}>
                    <div className="font-bold text-lg mb-3" style={{color:'var(--brand-primary)'}}>{cat}</div>
                    <div className="space-y-4">
                      {itens.map(p => (
                        <div key={p.id} className="bg-gray-50 rounded-lg p-4">
                          <div className="flex items-start justify-between mb-2">
                            <div className="flex-1 font-medium">{p.texto}</div>
                            <div className="flex items-center gap-2">
                              <span className={'badge text-sm ' + (respostas[p.id] === 'sim' ? 'bg-green-500 text-white' : 'bg-red-500 text-white')}>
                                {respostas[p.id] === 'sim' ? '✓ SIM' : '✗ NÃO'}
                              </span>
                              {p.fotoObrigatoria && <span className="badge bg-yellow-400 text-gray-900"><i className="fa fa-camera mr-1"></i>Foto</span>}
                            </div>
                          </div>
                          {evidencias[p.id] && (
                            <div className="mt-3">
                              <img src={evidencias[p.id]} alt={'Evidência '+p.id} className="w-full max-w-md h-48 object-cover rounded-lg border-2 border-gray-200"/>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {historicoDaLojaEPorTipo.length > 0 && (
              <div className="card p-6 mb-6">
                <div className="section-title">Histórico — {setSelecionado || 'Checklist Atual'}</div>
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="border-b-2">
                        <th className="py-3 text-left">Data</th>
                        <th className="py-3 text-left">Nota</th>
                        <th className="py-3 text-left">Duração</th>
                      </tr>
                    </thead>
                    <tbody>
                      {historicoDaLojaEPorTipo.map(h => {
                        const dur = h.inicioISO && h.fimISO ? humanDuration(new Date(h.fimISO) - new Date(h.inicioISO)) : '';
                        return (
                          <tr key={h.id} className="border-b">
                            <td className="py-3">{fmtDateTime(h.fimISO)}</td>
                            <td className="py-3 font-semibold">{h.nota}</td>
                            <td className="py-3">{dur}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            <div className="flex gap-3 no-print">
              <button onClick={() => window.print()} className="btn btn-primary"><i className="fa fa-print mr-2"></i>Imprimir / PDF</button>
              <button onClick={reiniciar} className="btn btn-ghost">Novo Checklist</button>
            </div>
          </div>
        );
      }

      // Checklist em andamento
      if (checklistIniciado) {
        return (
          <div className="max-w-5xl mx-auto p-6">
            <div className="flex items-center gap-4 mb-6">
              {brandLogo && <img src={brandLogo} alt="logo" className="h-10 w-auto"/>}
              <h1 className="text-2xl font-bold" style={{color: 'var(--brand-primary)'}}>Checklist em Andamento</h1>
            </div>

            <div className="card p-6 mb-6 bg-gradient-to-r from-blue-50 to-indigo-50">
              <div className="grid sm:grid-cols-2 gap-3 text-sm">
                <div><span className="font-semibold">Loja:</span> {lojaNome}</div>
                <div><span className="font-semibold">Tipo:</span> {setSelecionado || 'Checklist Atual'}</div>
                <div className="sm:col-span-2"><span className="font-semibold">Endereço:</span> {lojaEndereco}</div>
              </div>
            </div>

            <div className="space-y-6">
              {categorias.map(([cat, itens]) => (
                <div key={cat} className="card p-6">
                  <div className="font-bold text-xl mb-4" style={{color:'var(--brand-primary)'}}>{cat}</div>
                  <div className="space-y-4">
                    {itens.map(p => (
                      <div key={p.id} className="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-4 border-l-4" style={{borderColor: respostas[p.id] ? 'var(--brand-accent)' : '#d1d5db'}}>
                        <div className="font-medium mb-3">{p.texto}</div>
                        <div className="flex flex-wrap gap-3 mb-3">
                          <button
                            onClick={() => responder(p.id, 'sim')}
                            className={'btn ' + (respostas[p.id] === 'sim' ? 'btn-accent' : 'btn-ghost')}
                          >
                            <i className="fa fa-check mr-2"></i>SIM
                          </button>
                          <button
                            onClick={() => responder(p.id, 'nao')}
                            className={'btn ' + (respostas[p.id] === 'nao' ? 'bg-red-500 text-white' : 'btn-ghost')}
                          >
                            <i className="fa fa-times mr-2"></i>NÃO
                          </button>
                          {p.fotoObrigatoria && <span className="badge bg-yellow-400 text-gray-900 self-center"><i className="fa fa-camera mr-1"></i>Foto obrigatória</span>}
                        </div>
                        <div className="flex items-center gap-3">
                          <input type="file" accept="image/*" capture="environment" className="text-sm"
                                 onChange={(e) => handleEvidenciaUpload(p.id, e.target.files[0])}/>
                          {evidencias[p.id] && <span className="text-sm text-green-700 font-semibold"><i className="fa fa-check-circle mr-1"></i>Foto anexada</span>}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-8">
              <button
                onClick={finalizarChecklist}
                disabled={!todasRespondidas || !fotosOk}
                className={'btn btn-primary w-full text-lg py-4 ' + ((todasRespondidas && fotosOk) ? '' : 'opacity-50 cursor-not-allowed')}
              >
                <i className="fa fa-flag-checkered mr-2"></i>Finalizar e Gerar Relatório
              </button>
            </div>
          </div>
        );
      }

      // Dashboard principal com abas
      return (
        <div className="min-h-screen pb-12">
          {/* Header */}
          <div className="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex items-center gap-4">
                {brandLogo && <img src={brandLogo} alt="logo" className="h-12 w-auto"/>}
                <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent">
                  Checklist Auditoria
                </h1>
              </div>
            </div>
          </div>

          {/* Navegação por abas */}
          <div className="max-w-7xl mx-auto px-6 py-6">
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
              <div className={'tab-btn ' + (abaAtiva === 'inicio' ? 'active' : 'bg-white')} onClick={() => setAbaAtiva('inicio')}>
                <div className="icon"><i className="fas fa-home"></i></div>
                <div className="label">Início</div>
              </div>
              <div className={'tab-btn ' + (abaAtiva === 'loja' ? 'active' : 'bg-white')} onClick={() => setAbaAtiva('loja')}>
                <div className="icon"><i className="fas fa-store"></i></div>
                <div className="label">Loja</div>
              </div>
              <div className={'tab-btn ' + (abaAtiva === 'perguntas' ? 'active' : 'bg-white')} onClick={() => setAbaAtiva('perguntas')}>
                <div className="icon"><i className="fas fa-clipboard-list"></i></div>
                <div className="label">Perguntas</div>
              </div>
              <div className={'tab-btn ' + (abaAtiva === 'historico' ? 'active' : 'bg-white')} onClick={() => setAbaAtiva('historico')}>
                <div className="icon"><i className="fas fa-history"></i></div>
                <div className="label">Histórico</div>
              </div>
              <div className={'tab-btn ' + (abaAtiva === 'personalizacao' ? 'active' : 'bg-white')} onClick={() => setAbaAtiva('personalizacao')}>
                <div className="icon"><i className="fas fa-palette"></i></div>
                <div className="label">Personalização</div>
              </div>
            </div>

            {/* Conteúdo das abas */}
            {abaAtiva === 'inicio' && (
              <div className="space-y-6">
                <div className="card p-8 text-center bg-gradient-to-br from-blue-50 to-indigo-50">
                  <i className="fas fa-clipboard-check text-6xl mb-4" style={{color:'var(--brand-primary)'}}></i>
                  <h2 className="text-2xl font-bold mb-4" style={{color:'var(--brand-primary)'}}>Bem-vindo ao Sistema de Checklist</h2>
                  <p className="text-gray-700 mb-6">Configure sua loja, perguntas e personalize a marca antes de iniciar.</p>
                  
                  <div className="grid md:grid-cols-3 gap-4 text-left max-w-3xl mx-auto mb-6">
                    <div className="bg-white rounded-lg p-4 shadow-sm">
                      <div className="flex items-center gap-3 mb-2">
                        <i className="fas fa-store text-2xl" style={{color:'var(--brand-primary)'}}></i>
                        <div className="font-semibold">Loja</div>
                      </div>
                      <div className="text-sm text-gray-600">
                        {lojaNome ? <span className="text-green-600"><i className="fa fa-check mr-1"></i>Configurada</span> : <span className="text-red-600"><i className="fa fa-times mr-1"></i>Pendente</span>}
                      </div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm">
                      <div className="flex items-center gap-3 mb-2">
                        <i className="fas fa-map-marker-alt text-2xl" style={{color:'var(--brand-primary)'}}></i>
                        <div className="font-semibold">GPS</div>
                      </div>
                      <div className="text-sm text-gray-600">
                        {coords && gpsConfereEndereco ? <span className="text-green-600"><i className="fa fa-check mr-1"></i>Validado</span> : <span className="text-red-600"><i className="fa fa-times mr-1"></i>Pendente</span>}
                      </div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm">
                      <div className="flex items-center gap-3 mb-2">
                        <i className="fas fa-clipboard-list text-2xl" style={{color:'var(--brand-primary)'}}></i>
                        <div className="font-semibold">Perguntas</div>
                      </div>
                      <div className="text-sm text-gray-600">
                        {perguntas.length > 0 ? <span className="text-green-600"><i className="fa fa-check mr-1"></i>{perguntas.length} itens</span> : <span className="text-red-600"><i className="fa fa-times mr-1"></i>Nenhuma</span>}
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={iniciarChecklist}
                    disabled={!requisitosParaIniciar()}
                    className={'btn btn-accent text-xl py-4 px-8 ' + (requisitosParaIniciar() ? '' : 'opacity-50 cursor-not-allowed')}
                  >
                    <i className="fa fa-play mr-2"></i>Iniciar Checklist
                  </button>

                  {!requisitosParaIniciar() && (
                    <div className="mt-4 text-sm text-red-600">
                      <div className="font-semibold mb-2">Requisitos pendentes:</div>
                      <ul className="list-disc list-inside text-left max-w-md mx-auto">
                        {!lojaNome.trim() && <li>Configure o nome da loja</li>}
                        {!lojaEndereco.trim() && <li>Configure o endereço da loja</li>}
                        {!coords && <li>Capture a localização GPS</li>}
                        {coords && gpsConfereEndereco !== true && <li>Valide o endereço GPS</li>}
                        {perguntas.length === 0 && <li>Adicione perguntas ao checklist</li>}
                      </ul>
                    </div>
                  )}
                </div>
              </div>
            )}

            {abaAtiva === 'loja' && (
              <div className="space-y-6">
                <div className="card p-6">
                  <div className="section-title"><i className="fas fa-store mr-2"></i>Dados da Loja</div>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-semibold mb-2">Nome da Loja</label>
                      <input
                        type="text"
                        className="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:outline-none"
                        value={lojaNome}
                        onChange={(e) => salvarLojaNome(e.target.value)}
                        placeholder="Ex.: Loja Centro - Matriz"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold mb-2">Endereço Completo</label>
                      <input
                        type="text"
                        className="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:outline-none"
                        value={lojaEndereco}
                        onChange={(e) => salvarLojaEndereco(e.target.value)}
                        placeholder="Rua, número - Bairro, Cidade/UF"
                      />
                    </div>
                  </div>
                </div>

                <div className="card p-6">
                  <div className="section-title"><i className="fas fa-map-marker-alt mr-2"></i>Localização GPS</div>
                  <button className="btn btn-primary mb-4" onClick={capturarLocalizacao}>
                    <i className="fa fa-location-arrow mr-2"></i>Capturar Localização
                  </button>
                  {geoStatus === 'buscando' && <div className="text-sm text-gray-600 mb-2"><i className="fa fa-spinner fa-spin mr-2"></i>Buscando localização...</div>}
                  {geoErro && <div className="text-sm text-red-600 mb-2"><i className="fa fa-exclamation-circle mr-2"></i>{geoErro}</div>}
                  
                  {coords && (
                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 space-y-2 text-sm">
                      <div className="flex items-center gap-2">
                        <i className="fa fa-check-circle text-green-600"></i>
                        <span className="font-semibold">GPS Capturado</span>
                      </div>
                      <div><span className="font-semibold">Coordenadas:</span> {coords.latitude.toFixed(6)}, {coords.longitude.toFixed(6)}</div>
                      {coords.accuracy && <div><span className="font-semibold">Precisão:</span> ±{Math.round(coords.accuracy)} metros</div>}
                      {enderecoGPS && (
                        <div className="pt-2 border-t border-green-200">
                          <div className="font-semibold mb-1">Endereço GPS:</div>
                          <div className="text-gray-700">{enderecoGPS}</div>
                        </div>
                      )}
                      <div className={'font-bold pt-2 ' + (gpsConfereEndereco === true ? 'text-green-700' : gpsConfereEndereco === false ? 'text-red-700' : 'text-gray-600')}>
                        {gpsValidando ? 'Validando endereço...' :
                          gpsConfereEndereco === true ? '✓ Endereço GPS confere com a loja' :
                          gpsConfereEndereco === false ? '✗ Endereço GPS NÃO confere' :
                          'Aguardando validação'
                        }
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {abaAtiva === 'perguntas' && (
              <div className="space-y-6">
                <div className="card p-6">
                  <div className="section-title"><i className="fas fa-plus-circle mr-2"></i>Adicionar Pergunta</div>
                  <div className="grid md:grid-cols-12 gap-3 mb-4">
                    <input
                      className="md:col-span-3 border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:outline-none"
                      placeholder="Categoria"
                      value={novaCategoria}
                      onChange={(e) => setNovaCategoria(e.target.value)}
                    />
                    <input
                      className="md:col-span-7 border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:outline-none"
                      placeholder="Digite a pergunta..."
                      value={novaPergunta}
                      onChange={(e) => setNovaPergunta(e.target.value)}
                      onKeyPress={(e) => { if (e.key === 'Enter') adicionarPergunta(); }}
                    />
                    <label className="md:col-span-2 flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" checked={novaFotoObrigatoria} onChange={(e) => setNovaFotoObrigatoria(e.target.checked)} className="w-5 h-5"/>
                      <span className="text-sm font-semibold">Foto obrigatória</span>
                    </label>
                  </div>
                  <button className="btn btn-accent" onClick={adicionarPergunta}>
                    <i className="fa fa-plus mr-2"></i>Adicionar Pergunta
                  </button>
                </div>

                <div className="card p-6">
                  <div className="section-title"><i className="fas fa-file-csv mr-2"></i>Importar CSV</div>
                  <div className="flex flex-wrap items-center gap-3">
                    <input type="file" accept=".csv" className="text-sm" onChange={(e) => handleArquivoCSV(e.target.files?.[0])}/>
                    <button className="btn btn-ghost" onClick={baixarModeloCSV}>
                      <i className="fa fa-download mr-2"></i>Baixar Modelo
                    </button>
                  </div>
                  {uploadErro && <div className="text-sm text-red-600 mt-2"><i className="fa fa-exclamation-circle mr-2"></i>{uploadErro}</div>}
                </div>

                <div className="grid lg:grid-cols-2 gap-6">
                  <div className="card p-6">
                    <div className="section-title"><i className="fas fa-save mr-2"></i>Salvar Conjunto</div>
                    <div className="flex gap-3">
                      <input
                        className="flex-1 border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:outline-none"
                        placeholder="Nome do conjunto"
                        value={nomeSet}
                        onChange={(e) => setNomeSet(e.target.value)}
                      />
                      <button
                        className="btn btn-primary"
                        onClick={() => {
                          const nome = (nomeSet || '').trim();
                          if (!nome) { alert('Informe um nome.'); return; }
                          if (perguntas.length === 0) { alert('Sem perguntas para salvar.'); return; }
                          salvarSetLocal(nome, perguntas);
                          setNomeSet('');
                          alert('Conjunto salvo com sucesso!');
                        }}
                      >
                        <i className="fa fa-save mr-2"></i>Salvar
                      </button>
                    </div>
                  </div>

                  <div className="card p-6">
                    <div className="section-title"><i className="fas fa-folder-open mr-2"></i>Carregar Conjunto</div>
                    <div className="flex gap-3">
                      <select
                        className="flex-1 border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:outline-none"
                        value={setSelecionado}
                        onChange={(e) => setSetSelecionado(e.target.value)}
                      >
                        <option value="">Selecione um conjunto</option>
                        {setsSalvos.sort((a, b) => a.name.localeCompare(b.name)).map(s => (
                          <option key={s.name} value={s.name}>{s.name} ({s.count})</option>
                        ))}
                      </select>
                      <button
                        className="btn btn-ghost"
                        onClick={() => {
                          if (!setSelecionado) { alert('Selecione um conjunto.'); return; }
                          const lista = carregarSetLocal(setSelecionado);
                          if (!lista?.length) { alert('Conjunto vazio ou inválido.'); return; }
                          const mapped = lista.map((p, i) => ({ ...p, id: i + 1, categoria: p.categoria || 'Geral', fotoObrigatoria: !!p.fotoObrigatoria }));
                          setPerguntas(mapped);
                          setRespostas({});
                          setEvidencias({});
                          alert('Conjunto carregado!');
                        }}
                      >
                        <i className="fa fa-upload mr-2"></i>Carregar
                      </button>
                      <button
                        className="btn btn-ghost"
                        onClick={() => {
                          if (!setSelecionado) { alert('Selecione um conjunto.'); return; }
                          if (confirm(`Excluir conjunto "${setSelecionado}"?`)) {
                            excluirSetLocal(setSelecionado);
                            setSetSelecionado('');
                          }
                        }}
                      >
                        <i className="fa fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <div className="card p-6">
                  <div className="section-title"><i className="fas fa-list mr-2"></i>Lista de Perguntas ({perguntas.length})</div>
                  {perguntas.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <i className="fas fa-inbox text-4xl mb-3"></i>
                      <div>Nenhuma pergunta cadastrada ainda.</div>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {perguntas.map(p => (
                        <div key={p.id} className="flex items-center gap-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-4 border-l-4" style={{borderColor:'var(--brand-primary)'}}>
                          {editandoId === p.id ? (
                            <>
                              <input
                                className="w-40 border-2 border-gray-300 rounded px-3 py-2"
                                value={categoriaEdicao}
                                onChange={(e) => setCategoriaEdicao(e.target.value)}
                                placeholder="Categoria"
                              />
                              <input
                                className="flex-1 border-2 border-gray-300 rounded px-3 py-2"
                                value={textoEdicao}
                                onChange={(e) => setTextoEdicao(e.target.value)}
                              />
                              <label className="flex items-center gap-2 text-sm">
                                <input type="checkbox" checked={fotoObrigatoriaEdicao} onChange={(e) => setFotoObrigatoriaEdicao(e.target.checked)} className="w-4 h-4"/>
                                Foto
                              </label>
                              <button className="text-green-600 text-xl" onClick={salvarEdicao}><i className="fa fa-check"></i></button>
                              <button className="text-gray-600 text-xl" onClick={() => setEditandoId(null)}><i className="fa fa-times"></i></button>
                            </>
                          ) : (
                            <>
                              <span className="badge bg-blue-100 text-blue-700 font-semibold">{p.categoria || 'Geral'}</span>
                              <span className="flex-1 font-medium">{p.texto}</span>
                              {p.fotoObrigatoria && <span className="badge bg-yellow-400 text-gray-900"><i className="fa fa-camera mr-1"></i>Foto</span>}
                              <button className="text-blue-600 text-lg" onClick={() => iniciarEdicao(p.id)}><i className="fa fa-edit"></i></button>
                              <button className="text-red-600 text-lg" onClick={() => removerPergunta(p.id)}><i className="fa fa-trash"></i></button>
                            </>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}

            {abaAtiva === 'historico' && (
              <div className="space-y-6">
                <div className="card p-6">
                  <div className="section-title"><i className="fas fa-history mr-2"></i>Histórico de Checklists</div>
                  {historico.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <i className="fas fa-clipboard text-5xl mb-4"></i>
                      <div className="text-lg">Nenhum checklist realizado ainda.</div>
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full">
                        <thead>
                          <tr className="border-b-2 border-gray-300">
                            <th className="py-3 px-4 text-left font-bold">Data</th>
                            <th className="py-3 px-4 text-left font-bold">Loja</th>
                            <th className="py-3 px-4 text-left font-bold">Tipo</th>
                            <th className="py-3 px-4 text-left font-bold">Nota</th>
                            <th className="py-3 px-4 text-left font-bold">Ações</th>
                          </tr>
                        </thead>
                        <tbody>
                          {historico.map(h => (
                            <tr key={h.id} className="border-b hover:bg-gray-50">
                              <td className="py-3 px-4">{fmtDateTime(h.fimISO || h.createdAt)}</td>
                              <td className="py-3 px-4 font-medium">{h.lojaNome}</td>
                              <td className="py-3 px-4">{h.tipoChecklist}</td>
                              <td className="py-3 px-4">
                                <span className="badge bg-green-500 text-white text-sm font-bold">{h.nota}</span>
                              </td>
                              <td className="py-3
