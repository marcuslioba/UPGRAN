<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard de Vendas - Tempo Real</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --brand:#FF500A;
      --brand-600:#e04909;
      --ok:#10b981;
      --down:#ef4444;
      --ink:#1f2937;
      --muted:#6b7280;
      --bg:#f6f7fb;
      --card:#ffffff;
      --ring:rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      line-height:1.45;
    }
    .container{max-width:1280px;margin:0 auto;padding:20px}
    .header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
      color:var(--ink);
    }
    .logo{
      width:44px;height:44px;border-radius:10px;
      background:linear-gradient(135deg,var(--brand) 0%, #ff8a4a 100%);
      display:grid;place-items:center;color:#fff;font-weight:900;font-size:20px;
      box-shadow:0 8px 18px rgba(255,80,10,.25);
    }
    .title{font-size:1.4rem;font-weight:800}
    .subtitle{font-size:.9rem;color:var(--muted);margin-top:2px}
    .sync{
      display:flex;align-items:center;gap:10px;background:var(--card);
      padding:8px 14px;border-radius:999px;box-shadow:0 1px 2px var(--ring),0 8px 24px var(--ring);
      font-weight:700;color:var(--brand);
    }
    .dot{width:10px;height:10px;border-radius:50%;background:var(--ok)}
    .toolbar{
      display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px
    }
    .select{
      flex:1;min-width:260px;background:var(--card);border-radius:12px;
      padding:10px 12px;box-shadow:0 1px 2px var(--ring),0 8px 24px var(--ring);
      border:1px solid #eee;
    }
    .select select{
      width:100%;padding:10px 12px;border:2px solid var(--brand);border-radius:8px;
      background:#fff;font-weight:700;color:var(--ink)
    }

    .metrics{
      display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:14px
    }
    .card{
      background:var(--card);border-radius:14px;padding:14px;
      box-shadow:0 1px 2px var(--ring),0 8px 24px var(--ring);
    }
    .metric-label{color:var(--muted);font-size:.78rem;letter-spacing:.3px;text-transform:uppercase;font-weight:800;margin-bottom:4px}
    .metric-value{font-weight:900;color:var(--brand);font-size:1.4rem}
    .trend{margin-top:4px;font-weight:700;font-size:.92rem}
    .up{color:var(--ok)} .down{color:var(--down)}

    .grid-2-1{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:14px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px}
    .card-title{font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .canvas-wrap{height:220px}
    .canvas-wrap.sm{height:200px}
    .gauge-wrap{height:140px;display:flex;align-items:center;justify-content:center}

    .tops{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px}
    .top-item{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border-radius:10px;padding:8px 10px;margin-bottom:8px}
    .top-rank{font-size:1.1rem;font-weight:900;margin-right:10px}
    .top-name{flex:1;font-weight:700}
    .top-val{font-weight:900;color:var(--brand)}

    .table-card{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th{background:var(--brand);color:#fff;padding:10px;text-align:left;font-weight:800}
    td{padding:10px;border-bottom:1px solid #eee}
    tr:hover{background:#fff5f0}

    @media (max-width:1100px){
      .metrics{grid-template-columns:repeat(3,1fr)}
      .grid-2-1{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
      .tops{grid-template-columns:1fr}
      .canvas-wrap{height:220px}
    }
    @media (max-width:640px){
      .metrics{grid-template-columns:repeat(2,1fr)}
      .title{font-size:1.1rem}
      .logo{width:40px;height:40px;font-size:18px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">DV</div>
        <div>
          <div class="title">Dashboard de Vendas</div>
          <div class="subtitle">Tempo real ‚Ä¢ minimalista</div>
        </div>
      </div>
      <div class="sync">
        <div class="dot" id="syncDot"></div>
        <span id="syncStatus">Sincronizando...</span>
      </div>
    </div>

    <div class="toolbar">
      <div class="select">
        <select id="storeSelect" onchange="updateDashboard()">
          <option value="all">üìç Todas as Lojas</option>
        </select>
      </div>
    </div>

    <div class="metrics">
      <div class="card">
        <div class="metric-label">Vendas Totais</div>
        <div class="metric-value" id="totalSales">R$ 0</div>
        <div class="trend" id="salesTrend"></div>
      </div>
      <div class="card">
        <div class="metric-label">Vendas Balc√£o</div>
        <div class="metric-value" id="counterSales">R$ 0</div>
      </div>
      <div class="card">
        <div class="metric-label">Delivery</div>
        <div class="metric-value" id="deliverySales">R$ 0</div>
        <div class="trend" id="deliveryTrend"></div>
      </div>
      <div class="card">
        <div class="metric-label">% Delivery</div>
        <div class="metric-value" id="deliveryPercent">0%</div>
      </div>
      <div class="card">
        <div class="metric-label">Previs√£o M√™s</div>
        <div class="metric-value" id="forecast">R$ 0</div>
      </div>
      <div class="card">
        <div class="metric-label">Meta do M√™s</div>
        <div class="metric-value" id="goalValue">R$ 0</div>
        <div class="trend" id="goalStatus"></div>
      </div>
    </div>

    <div class="grid-2-1">
      <div class="card">
        <div class="card-title">üìà Evolu√ß√£o de Vendas</div>
        <div class="canvas-wrap"><canvas id="salesChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üéØ Progresso da Meta</div>
        <div class="gauge-wrap"><canvas id="gaugeChart"></canvas></div>
      </div>
    </div>

    <div class="tops">
      <div class="card">
        <div class="card-title">üèÜ Top 3 Melhores Lojas</div>
        <div id="topStores"></div>
      </div>
      <div class="card">
        <div class="card-title">‚ö†Ô∏è Top 3 Lojas em Alerta</div>
        <div id="bottomStores"></div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">üöö Evolu√ß√£o do Delivery</div>
        <div class="canvas-wrap sm"><canvas id="deliveryChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üè™ Vendas por Loja</div>
        <div class="canvas-wrap"><canvas id="storesChart"></canvas></div>
      </div>
    </div>

    <div class="card table-card">
      <div class="card-title">üìã Resumo Detalhado por Loja</div>
      <table id="storesTable">
        <thead>
          <tr>
            <th>Loja</th>
            <th>Vendas Balc√£o</th>
            <th>Delivery</th>
            <th>Total</th>
            <th>% Delivery</th>
            <th>Previs√£o M√™s</th>
            <th>Meta</th>
            <th>Status Meta</th>
            <th>Tend√™ncia</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // CONFIG
    const USE_APPS_SCRIPT = true;
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzA5tqE0f7KpJ3ldeQ7ancb5itCQlUWHUbF1n9Jrjq5mdogGuiMC_kvhELnfFXSwdlJ/exec';
    const REFRESH_INTERVAL = 10000;

    let salesData = [];
    let salesChart, storesChart, deliveryChart, gaugeChart;

    function setSync(msg, isError=false){
      document.getElementById('syncStatus').textContent = msg;
      document.getElementById('syncDot').style.background = isError ? 'var(--down)' : 'var(--ok)';
      document.title = 'Dashboard ‚Ä¢ ' + msg;
    }

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb + '&t=' + Date.now();
        window[cb] = (data) => { resolve(data); cleanup(); };
        s.onerror = (e) => { reject(e); cleanup(); };
        function cleanup(){ try{ document.body.removeChild(s); }catch{} delete window[cb]; }
        document.body.appendChild(s);
      });
    }

    async function loadDataFromSource() {
      try{
        setSync('Sincronizando...');
        let dataRows;
        if (USE_APPS_SCRIPT) {
          dataRows = await jsonp(SHEET_API_URL);
        } else {
          throw new Error('Configure USE_APPS_SCRIPT = true');
        }

        if (!Array.isArray(dataRows) || dataRows.length === 0) throw new Error('Sem dados');

        salesData = dataRows.map(row => ({
          date: parseDate(row.date),
          store: String(row.store || '').trim(),
          counter: num(row.counter),
          delivery: num(row.delivery),
          goal: num(row.goal)
        })).filter(r => r.store);

        salesData.sort((a,b)=> a.date - b.date);

        populateStoreSelector();
        updateDashboard();
        setSync('Atualizado agora');
      }catch(e){
        console.error(e);
        setSync('Erro na sincroniza√ß√£o', true);
      }
    }

    function num(v){ const n = parseFloat(String(v).toString().replace(/\./g,'').replace(',','.')); return isNaN(n)?0:n; }
    function parseDate(s){
      if (!s) return new Date();
      const p = String(s).trim().split('/');
      if (p.length===3){
        const d = new Date(+p[2], +p[1]-1, +p[0]);
        if (!isNaN(d)) return d;
      }
      const d = new Date(s);
      return isNaN(d) ? new Date() : d;
    }
    function money(v){ return 'R$ ' + Number(v).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}); }

    function populateStoreSelector(){
      const stores = [...new Set(salesData.map(d=>d.store))];
      const sel = document.getElementById('storeSelect');
      const cur = sel.value;
      sel.innerHTML = '<option value="all">üìç Todas as Lojas</option>' +
        stores.map(s=>`<option value="${s}">üè™ ${s}</option>`).join('');
      if (stores.includes(cur)) sel.value = cur;
    }

    function updateDashboard(){
      const selected = document.getElementById('storeSelect').value;
      const data = selected==='all' ? salesData : salesData.filter(d=>d.store===selected);
      updateMetrics(data, selected);
      updateSalesChart(data);
      updateDeliveryChart(data);
      if (selected==='all') updateStoresChart();
      updateTable();
      updateTopStores();
    }

    function updateMetrics(data, selectedStore){
      const totalCounter = data.reduce((s,d)=>s+d.counter,0);
      const totalDelivery = data.reduce((s,d)=>s+d.delivery,0);
      const totalSales = totalCounter + totalDelivery;

      const dates = data.map(d=>d.date);
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      const daysInData = Math.max(1, Math.ceil((maxDate - minDate)/(1000*60*60*24))+1);
      const avgDaily = totalSales / daysInData;
      const daysInMonth = new Date(maxDate.getFullYear(), maxDate.getMonth()+1, 0).getDate();
      const forecast = avgDaily * daysInMonth;

      const goal = selectedStore==='all'
        ? [...new Set(salesData.map(d=>d.store))].reduce((sum, store)=>{
            const g = salesData.find(d=>d.store===store && d.goal>0)?.goal || 0;
            return sum + g;
          },0)
        : (data.find(d=>d.goal>0)?.goal || 0);

      const deliveryPercent = totalSales>0 ? (totalDelivery/totalSales*100) : 0;
      const salesTrend = calcTrend(data.map(d=>({sales:d.counter+d.delivery})));
      const deliveryTrend = calcTrend(data.map(d=>({sales:d.delivery})));

      document.getElementById('totalSales').textContent = money(totalSales);
      document.getElementById('counterSales').textContent = money(totalCounter);
      document.getElementById('deliverySales').textContent = money(totalDelivery);
      document.getElementById('deliveryPercent').textContent = deliveryPercent.toFixed(1)+'%';
      document.getElementById('forecast').textContent = money(forecast);
      document.getElementById('goalValue').textContent = money(goal);

      document.getElementById('salesTrend').innerHTML = salesTrend>=0
        ? `<span class="up">‚ñ≤ ${salesTrend.toFixed(1)}%</span>` : `<span class="down">‚ñº ${Math.abs(salesTrend).toFixed(1)}%</span>`;
      document.getElementById('deliveryTrend').innerHTML = deliveryTrend>=0
        ? `<span class="up">‚ñ≤ ${deliveryTrend.toFixed(1)}%</span>` : `<span class="down">‚ñº ${Math.abs(deliveryTrend).toFixed(1)}%</span>`;

      document.getElementById('goalStatus').innerHTML = forecast>=goal
        ? `<span class="up">‚úì No caminho</span>` : `<span class="down">‚úó Abaixo</span>`;

      updateGaugeChart(forecast, goal);
    }

    function calcTrend(arr){
      if (arr.length<2) return 0;
      const m = Math.floor(arr.length/2);
      const f = arr.slice(0,m).reduce((s,d)=>s+d.sales,0)/Math.max(1,m);
      const s = arr.slice(m).reduce((s2,d)=>s2+d.sales,0)/Math.max(1,arr.length-m);
      if (f===0) return 0;
      return ((s-f)/f)*100;
    }

    // Charts minimalistas
    function updateSalesChart(data){
      const daily = {};
      data.forEach(d=>{
        const k = d.date.toLocaleDateString('pt-BR');
        if (!daily[k]) daily[k] = {counter:0, delivery:0};
        daily[k].counter += d.counter;
        daily[k].delivery += d.delivery;
      });
      const labels = Object.keys(daily);
      const counterValues = labels.map(k=>daily[k].counter);
      const deliveryValues = labels.map(k=>daily[k].delivery);

      if (salesChart) salesChart.destroy();
      const ctx = document.getElementById('salesChart').getContext('2d');
      salesChart = new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[
          { data:counterValues, borderColor:'var(--brand)', tension:.35, borderWidth:2, pointRadius:0 },
          { data:deliveryValues, borderColor:'var(--ok)', tension:.35, borderWidth:2, pointRadius:0 }
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, title:{display:false}, tooltip:{mode:'index',intersect:false} },
          elements:{ point:{radius:0} },
          scales:{
            x:{ grid:{display:false}, ticks:{ maxTicksLimit:6 }},
            y:{ grid:{display:false}, beginAtZero:true, ticks:{ maxTicksLimit:4, callback:v=>'R$ '+Number(v).toLocaleString('pt-BR') } }
          }
        }
      });
    }

    function updateDeliveryChart(data){
      const daily = {};
      data.forEach(d=>{
        const k = d.date.toLocaleDateString('pt-BR');
        daily[k] = (daily[k]||0) + d.delivery;
      });
      const labels = Object.keys(daily);
      const values = labels.map(k=>daily[k]);

      if (deliveryChart) deliveryChart.destroy();
      const ctx = document.getElementById('deliveryChart').getContext('2d');
      deliveryChart = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ data:values, backgroundColor:'var(--ok)', borderWidth:0, barPercentage:.6, categoryPercentage:.8 }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, title:{display:false} },
          scales:{
            x:{ grid:{display:false}, ticks:{maxTicksLimit:6}},
            y:{ grid:{display:false}, beginAtZero:true,
                ticks:{ maxTicksLimit:4, callback:v=>'R$ '+Number(v).toLocaleString('pt-BR') } }
          }
        }
      });
    }

    function updateStoresChart(){
      const stores = {};
      salesData.forEach(d=>{
        if (!stores[d.store]) stores[d.store] = {counter:0, delivery:0};
        stores[d.store].counter += d.counter;
        stores[d.store].delivery += d.delivery;
      });
      const labels = Object.keys(stores);
      const counterValues = labels.map(s=>stores[s].counter);
      const deliveryValues = labels.map(s=>stores[s].delivery);

      if (storesChart) storesChart.destroy();
      const ctx = document.getElementById('storesChart').getContext('2d');
      storesChart = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[
            {label:'Balc√£o', data:counterValues, backgroundColor:'var(--brand)'},
            {label:'Delivery', data:deliveryValues, backgroundColor:'var(--ok)'}
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true, position:'top'} },
          scales:{
            x:{ stacked:true },
            y:{ stacked:true, beginAtZero:true,
                ticks:{ callback:v=>'R$ '+Number(v).toLocaleString('pt-BR') } }
          }
        }
      });
    }

    function updateGaugeChart(forecast, goal){
      const pct = goal>0 ? Math.min((forecast/goal)*100, 100) : 0;
      if (gaugeChart) gaugeChart.destroy();
      const ctx = document.getElementById('gaugeChart').getContext('2d');
      gaugeChart = new Chart(ctx,{
        type:'doughnut',
        data:{ datasets:[{ data:[pct, 100-pct],
          backgroundColor:[ pct>=100?'var(--ok)' : pct>=80 ? 'var(--brand)' : 'var(--down)', '#e5e7eb' ],
          borderWidth:0 }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          circumference:180, rotation:270, cutout:'78%',
          plugins:{ legend:{display:false}, tooltip:{enabled:false} }
        },
        plugins:[{
          id:'gaugeText',
          afterDraw:(chart)=>{
            const c = chart.ctx, a = chart.chartArea;
            const cx = a.left + (a.right-a.left)/2;
            const cy = a.top + (a.bottom-a.top)/2 + 10;
            c.save();
            c.font = '900 22px Inter, Arial';
            c.fillStyle = 'var(--ink)';
            c.textAlign='center'; c.textBaseline='middle';
            c.fillText(pct.toFixed(1)+'%', cx, cy);
            c.font = '600 12px Inter, Arial'; c.fillStyle='var(--muted)';
            c.fillText('da meta', cx, cy+18);
            c.restore();
          }
        }]
      });
    }

    function updateTopStores(){
      const stores = [...new Set(salesData.map(d=>d.store))];
      const stats = stores.map(store=>{
        const sd = salesData.filter(d=>d.store===store);
        const total = sd.reduce((s,d)=>s+d.counter+d.delivery,0);
        const dates = sd.map(d=>d.date);
        const minD = new Date(Math.min(...dates)); const maxD = new Date(Math.max(...dates));
        const days = Math.max(1, Math.ceil((maxD-minD)/(1000*60*60*24))+1);
        const avg = total/days; const dim = new Date(maxD.getFullYear(), maxD.getMonth()+1, 0).getDate();
        const forecast = avg*dim;
        return {store,total,forecast};
      }).sort((a,b)=>b.total-a.total);

      document.getElementById('topStores').innerHTML = stats.slice(0,3).map((s,i)=>`
        <div class="top-item">
          <div class="top-rank">${['ü•á','ü•à','ü•â'][i]}</div>
          <div class="top-name">${s.store}</div>
          <div class="top-val">${money(s.total)}</div>
        </div>`).join('');

      document.getElementById('bottomStores').innerHTML = stats.slice(-3).reverse().map((s,i)=>`
        <div class="top-item">
          <div class="top-rank">${i+1}</div>
          <div class="top-name">${s.store}</div>
          <div class="top-val">${money(s.total)}</div>
        </div>`).join('');
    }

    function updateTable(){
      const stores = [...new Set(salesData.map(d=>d.store))];
      const tbody = document.querySelector('#storesTable tbody');
      tbody.innerHTML = '';
      stores.forEach(store=>{
        const sd = salesData.filter(d=>d.store===store);
        const totalCounter = sd.reduce((s,d)=>s+d.counter,0);
        const totalDelivery = sd.reduce((s,d)=>s+d.delivery,0);
        const total = totalCounter+totalDelivery;

        const dates = sd.map(d=>d.date);
        const minD = new Date(Math.min(...dates)); const maxD = new Date(Math.max(...dates));
        const days = Math.max(1, Math.ceil((maxD-minD)/(1000*60*60*24))+1);
        const avg = total/days; const dim = new Date(maxD.getFullYear(), maxD.getMonth()+1, 0).getDate();
        const forecast = avg*dim;
        const goal = sd.find(d=>d.goal>0)?.goal || 0;
        const delPct = total>0 ? (totalDelivery/total*100) : 0;
        const trend = calcTrend(sd.map(d=>({sales:d.counter+d.delivery})));
        const trendIcon = trend>=0 ? 'üìà' : 'üìâ';
        const trendClass = trend>=0 ? 'up' : 'down';
        const goalBadge = forecast>=goal ? '<span class="up">‚úì Atingir√°</span>' : '<span class="down">‚úó Abaixo</span>';

        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td><strong>${store}</strong></td>
            <td>${money(totalCounter)}</td>
            <td>${money(totalDelivery)}</td>
            <td><strong>${money(total)}</strong></td>
            <td>${delPct.toFixed(1)}%</td>
            <td>${money(forecast)}</td>
            <td>${money(goal)}</td>
            <td>${goalBadge}</td>
            <td class="${trendClass}">${trendIcon} ${trend.toFixed(1)}%</td>
          </tr>
        `);
      });
    }

    // Inicializa√ß√£o
    loadDataFromSource();
    setInterval(loadDataFromSource, REFRESH_INTERVAL);
  </script>
</body>
</html>
