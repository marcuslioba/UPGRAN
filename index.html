<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#2563eb"/>
  <title>Checklist Auditoria Pro</title>
  <meta name="description" content="Sistema profissional de checklist com geolocaliza√ß√£o, evid√™ncias fotogr√°ficas e relat√≥rios completos." />
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2hlY2tsaXN0IEF1ZGl0b3JpYSBQcm8iLCJzaG9ydF9uYW1lIjoiQ2hlY2tsaXN0Iiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3RleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCclM0UlRjAlOUYlOTMlOEIlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìã%3C/text%3E%3C/svg%3E">

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    
    body { 
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    /* Utilit√°rios de acessibilidade */
    .sr-only { 
      position: absolute; 
      width: 1px; 
      height: 1px; 
      padding: 0; 
      margin: -1px; 
      overflow: hidden; 
      clip: rect(0,0,0,0); 
      white-space: nowrap; 
      border: 0; 
    }
    
    /* Toast notifications */
    .toast {
      position: fixed; 
      right: 16px; 
      bottom: 16px; 
      z-index: 9999;
      background: #111827; 
      color: #fff; 
      padding: 12px 16px; 
      border-radius: 8px; 
      box-shadow: 0 10px 25px rgba(0,0,0,.2);
      display: flex; 
      gap: 10px; 
      align-items: center; 
      font-size: 14px;
      animation: slideIn 0.3s ease-out;
      max-width: 90vw;
    }
    .toast-success { background: #065f46; }
    .toast-error { background: #991b1b; }
    .toast-warning { background: #92400e; }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Badge component */
    .badge { 
      display: inline-block; 
      padding: 3px 10px; 
      border-radius: 9999px; 
      font-size: 11px; 
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Wizard steps */
    .wizard-step {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .wizard-step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    
    .wizard-step-line {
      flex: 1;
      height: 3px;
      background: #e5e7eb;
      transition: all 0.3s;
    }
    
    .wizard-step.active .wizard-step-circle {
      background: #2563eb;
      color: white;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
    }
    
    .wizard-step.completed .wizard-step-circle {
      background: #10b981;
      color: white;
    }
    
    .wizard-step.completed .wizard-step-line {
      background: #10b981;
    }
    
    .wizard-step.inactive .wizard-step-circle {
      background: #e5e7eb;
      color: #9ca3af;
    }
    
    /* Bot√µes com estados melhorados */
    .btn {
      transition: all 0.2s;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:active:not(:disabled) {
      transform: scale(0.98);
    }
    
    .btn:focus {
      outline: 2px solid;
      outline-offset: 2px;
    }
    
    /* Cards com eleva√ß√£o */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s;
    }
    
    .card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Input com foco melhorado */
    input:focus, select:focus, textarea:focus {
      outline: none;
      ring: 2px;
      border-color: #2563eb;
    }
    
    /* Anima√ß√£o de loading */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Print styles */
    @media print {
      .no-print { display: none !important; }
      body { 
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;
        background: white !important;
      }
      .card { box-shadow: none; border: 1px solid #e5e7eb; }
    }
    
    /* Responsividade melhorada */
    @media (max-width: 640px) {
      .wizard-step-label { display: none; }
      .toast { right: 8px; bottom: 8px; font-size: 13px; }
    }
    
    /* Tooltip simples */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #1f2937;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Melhorias de contraste */
    .text-muted { color: #6b7280; }
    .text-success { color: #059669; }
    .text-error { color: #dc2626; }
    .text-warning { color: #d97706; }
    
    /* Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ============================================
    // HOOK: Toast Notifications
    // ============================================
    function useToast() {
      const [toast, setToast] = useState(null);
      
      const show = useCallback((msg, type='success', timeout=3000) => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), timeout);
      }, []);
      
      const Toast = () => toast ? (
        <div 
          role="status" 
          aria-live="polite" 
          className={'toast toast-' + toast.type}
        >
          <i className={'fas ' + (
            toast.type === 'error' ? 'fa-times-circle' : 
            toast.type === 'warning' ? 'fa-exclamation-triangle' : 
            'fa-check-circle'
          )}></i>
          <span>{toast.msg}</span>
        </div>
      ) : null;
      
      return { show, Toast };
    }

    // ============================================
    // COMPONENTE: Wizard Steps
    // ============================================
    function WizardSteps({ currentStep, steps }) {
      return (
        <div className="no-print mb-6 sm:mb-8">
          <div className="flex items-center justify-between">
            {steps.map((step, idx) => (
              <div 
                key={step.n} 
                className={'wizard-step ' + (
                  currentStep > step.n ? 'completed' : 
                  currentStep === step.n ? 'active' : 
                  'inactive'
                )}
              >
                <div className="wizard-step-circle" aria-label={'Passo ' + step.n}>
                  {currentStep > step.n ? <i className="fas fa-check"></i> : step.n}
                </div>
                <span className="wizard-step-label hidden sm:inline text-xs font-semibold text-gray-700">
                  {step.label}
                </span>
                {idx < steps.length - 1 && <div className="wizard-step-line"></div>}
              </div>
            ))}
          </div>
          <div className="mt-4 bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
            <p className="text-sm text-blue-900 font-medium">
              <i className="fas fa-info-circle mr-2"></i>
              {currentStep === 1 && 'Preencha o nome e endere√ßo da loja'}
              {currentStep === 2 && 'Capture e valide sua localiza√ß√£o GPS'}
              {currentStep === 3 && 'Configure as perguntas do checklist'}
              {currentStep === 4 && 'Clique em "Iniciar Checklist" para come√ßar'}
              {currentStep === 5 && 'Checklist em andamento'}
              {currentStep === 6 && 'Relat√≥rio finalizado'}
            </p>
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE: Help Tooltip
    // ============================================
    function HelpTooltip({ text }) {
      return (
        <div className="tooltip inline-block ml-2">
          <i className="fas fa-question-circle text-gray-400 hover:text-gray-600 cursor-help"></i>
          <span className="tooltiptext">{text}</span>
        </div>
      );
    }

    // ============================================
    // COMPONENTE PRINCIPAL: App
    // ============================================
    function App() {
      const { show, Toast } = useToast();
      
      // Estados: Perguntas
      const [perguntas, setPerguntas] = useState([
        { id: 1, categoria: 'Seguran√ßa', texto: 'EPIs conferidos?', fotoObrigatoria: true },
        { id: 2, categoria: 'Opera√ß√£o', texto: 'Equipamentos verificados?', fotoObrigatoria: false },
        { id: 3, categoria: 'Documenta√ß√£o', texto: 'Documentos atualizados?', fotoObrigatoria: false },
      ]);
      const [novaPergunta, setNovaPergunta] = useState('');
      const [novaCategoria, setNovaCategoria] = useState('');
      const [novaFotoObrigatoria, setNovaFotoObrigatoria] = useState(false);
      const [editandoIndex, setEditandoIndex] = useState(null);
      const [textoEdicao, setTextoEdicao] = useState('');
      const [categoriaEdicao, setCategoriaEdicao] = useState('');
      const [fotoObrigatoriaEdicao, setFotoObrigatoriaEdicao] = useState(false);

      // Estados: Fluxo
      const [checklistIniciado, setChecklistIniciado] = useState(false);
      const [checklistFinalizado, setChecklistFinalizado] = useState(false);
      const [passo, setPasso] = useState(1);

      // Estados: Loja
      const [lojaNome, setLojaNome] = useState('');
      const [lojaEndereco, setLojaEndereco] = useState('');

      // Estados: Geolocaliza√ß√£o
      const [geoStatus, setGeoStatus] = useState('idle');
      const [coords, setCoords] = useState(null);
      const [enderecoGPS, setEnderecoGPS] = useState('');
      const [geoErro, setGeoErro] = useState('');
      const [gpsConfereEndereco, setGpsConfereEndereco] = useState(null);
      const [gpsValidando, setGpsValidando] = useState(false);
      const [alvoLat, setAlvoLat] = useState('');
      const [alvoLon, setAlvoLon] = useState('');
      const [alvoRaio, setAlvoRaio] = useState(100);
      const [distancia, setDistancia] = useState(null);
      const [dentroDaArea, setDentroDaArea] = useState(false);

      // Estados: Respostas e evid√™ncias
      const [respostas, setRespostas] = useState({});
      const [evidencias, setEvidencias] = useState({});

      // Estados: Tempo
      const [inicioISO, setInicioISO] = useState(null);
      const [fimISO, setFimISO] = useState(null);

      // Estados: CSV e Sets
      const [uploadErro, setUploadErro] = useState('');
      const [nomeSet, setNomeSet] = useState('');
      const [setsSalvos, setSetsSalvos] = useState([]);
      const [setSelecionado, setSetSelecionado] = useState('');
      
      // Estados: Valida√ß√£o
      const [erroInicio, setErroInicio] = useState('');

      // ============================================
      // UTILIT√ÅRIOS
      // ============================================
      const formatarDataHora = (iso) => {
        if (!iso) return '';
        const d = new Date(iso);
        return d.toLocaleString('pt-BR', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      };

      const duracaoHumana = (ms) => {
        if (!ms || ms < 0) return '';
        const s = Math.floor(ms / 1000);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const seg = s % 60;
        return [
          h ? h + 'h' : null, 
          (m || h) ? m + 'm' : null, 
          seg + 's'
        ].filter(Boolean).join(' ');
      };

      const toRad = (deg) => (deg * Math.PI) / 180;

      const haversineMeters = (lat1, lon1, lat2, lon2) => {
        const R = 6371000;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + 
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                  Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      };

      const normalizarTexto = (s) => {
        return (s || '')
          .toString()
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[.,;:]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      };

      const extrairTokensEndereco = (s) => {
        const t = normalizarTexto(s);
        return t.split(' ').filter(w => w && !/^\d{1,2}$/.test(w));
      };

      const enderecoCoincide = (endLoja, endGPS) => {
        const a = new Set(extrairTokensEndereco(endLoja));
        const b = new Set(extrairTokensEndereco(endGPS));
        let inter = 0;
        for (const token of a) {
          if (b.has(token)) inter++;
        }
        return inter >= 3;
      };

      // ============================================
      // LOCALSTORAGE: Sets de perguntas
      // ============================================
      const LS_META_KEY = 'checklist_sets_meta';

      const carregarMeta = () => {
        try { 
          return JSON.parse(localStorage.getItem(LS_META_KEY) || '[]'); 
        } catch { 
          return []; 
        }
      };

      const salvarMeta = (meta) => {
        localStorage.setItem(LS_META_KEY, JSON.stringify(meta));
      };

      const salvarSetLocal = (nome, listaPerguntas) => {
        if (!nome || !listaPerguntas || listaPerguntas.length === 0) return;
        localStorage.setItem('checklist_set::' + nome, JSON.stringify(listaPerguntas));
        const meta = carregarMeta();
        const idx = meta.findIndex(m => m.name === nome);
        const item = { 
          name: nome, 
          count: listaPerguntas.length, 
          updatedAt: new Date().toISOString() 
        };
        if (idx >= 0) {
          meta[idx] = item;
        } else {
          meta.push(item);
        }
        salvarMeta(meta);
        setSetsSalvos(meta);
      };

      const carregarSetLocal = (nome) => {
        try { 
          return JSON.parse(localStorage.getItem('checklist_set::' + nome) || 'null'); 
        } catch { 
          return null; 
        }
      };

      const excluirSetLocal = (nome) => {
        localStorage.removeItem('checklist_set::' + nome);
        const meta = carregarMeta().filter(m => m.name !== nome);
        salvarMeta(meta);
        setSetsSalvos(meta);
      };

      // ============================================
      // LOCALSTORAGE: Dados da loja
      // ============================================
      const salvarLojaNome = (nome) => { 
        localStorage.setItem('loja_nome', nome); 
        setLojaNome(nome); 
      };

      const salvarLojaEndereco = (endereco) => { 
        localStorage.setItem('loja_endereco', endereco); 
        setLojaEndereco(endereco); 
      };

      const carregarDadosLoja = () => {
        setLojaNome(localStorage.getItem('loja_nome') || '');
        setLojaEndereco(localStorage.getItem('loja_endereco') || '');
      };

      useEffect(() => {
        setSetsSalvos(carregarMeta());
        carregarDadosLoja();
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('data:text/javascript;base64,').catch(() => {});
        }
      }, []);

      // ============================================
      // GEOLOCALIZA√á√ÉO
      // ============================================
      const validarEnderecoGPS = (endGPS, endLoja) => {
        setGpsValidando(true);
        try {
          const ok = enderecoCoincide(endLoja, endGPS);
          setGpsConfereEndereco(ok);
          if (ok) {
            show('Endere√ßo GPS validado com sucesso!', 'success');
          } else {
            show('Endere√ßo GPS n√£o confere com o da loja', 'warning', 4000);
          }
        } finally {
          setGpsValidando(false);
        }
      };

      const capturarLocalizacao = () => {
        setGeoErro('');
        if (!('geolocation' in navigator)) {
          setGeoStatus('erro');
          setGeoErro('Geolocaliza√ß√£o n√£o suportada no navegador.');
          show('Geolocaliza√ß√£o n√£o suportada', 'error');
          return;
        }
        
        setGeoStatus('buscando');
        show('Capturando localiza√ß√£o...', 'success', 2000);
        
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude, accuracy } = pos.coords;
            const c = { latitude, longitude, accuracy };
            setCoords(c);
            setGeoStatus('ok');

            if (!alvoLat || !alvoLon) {
              setAlvoLat(latitude.toString());
              setAlvoLon(longitude.toString());
              setDistancia(0);
              setDentroDaArea(true);
            } else {
              const d = haversineMeters(
                parseFloat(latitude),
                parseFloat(longitude),
                parseFloat(alvoLat),
                parseFloat(alvoLon)
              );
              setDistancia(d);
              setDentroDaArea(d <= (parseFloat(alvoRaio) || 0));
            }

            try {
              const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
              const resp = await fetch(url, { 
                headers: { 'Accept-Language': 'pt-BR' } 
              });
              if (resp.ok) {
                const data = await resp.json();
                const end = data.display_name || '';
                setEnderecoGPS(end);
                if (lojaEndereco.trim()) {
                  validarEnderecoGPS(end, lojaEndereco);
                }
              }
            } catch (e) {
              console.error('Erro ao buscar endere√ßo:', e);
              show('Localiza√ß√£o capturada, mas n√£o foi poss√≠vel obter o endere√ßo', 'warning');
            }
          },
          (err) => {
            setGeoStatus('erro');
            const msg = err.message || 'Falha ao obter localiza√ß√£o.';
            setGeoErro(msg);
            show('Erro ao capturar localiza√ß√£o: ' + msg, 'error', 4000);
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      };

      // ============================================
      // PERGUNTAS: CRUD
      // ============================================
      const proximoId = useMemo(
        () => (perguntas.length ? Math.max(...perguntas.map(p => p.id)) + 1 : 1),
        [perguntas]
      );

      const adicionarPergunta = () => {
        if (!novaPergunta.trim()) {
          show('Digite uma pergunta v√°lida', 'warning');
          return;
        }
        const cat = novaCategoria.trim() || 'Geral';
        setPerguntas(p => [...p, {
          id: proximoId,
          categoria: cat,
          texto: novaPergunta.trim(),
          fotoObrigatoria: !!novaFotoObrigatoria
        }]);
        setNovaPergunta('');
        setNovaCategoria('');
        setNovaFotoObrigatoria(false);
        show('Pergunta adicionada!', 'success');
      };

      const removerPergunta = (id) => {
        setPerguntas(perguntas.filter(p => p.id !== id));
        show('Pergunta removida', 'success');
      };

      const iniciarEdicao = (id) => {
        const idx = perguntas.findIndex(p => p.id === id);
        if (idx < 0) return;
        setEditandoIndex(id);
        setTextoEdicao(perguntas[idx].texto);
        setCategoriaEdicao(perguntas[idx].categoria);
        setFotoObrigatoriaEdicao(!!perguntas[idx].fotoObrigatoria);
      };

      const salvarEdicao = () => {
        if (editandoIndex == null) return;
        const novas = perguntas.map(p => p.id === editandoIndex ? ({
          ...p,
          texto: textoEdicao.trim() || p.texto,
          categoria: categoriaEdicao.trim() || 'Geral',
          fotoObrigatoria: !!fotoObrigatoriaEdicao
        }) : p);
        setPerguntas(novas);
        setEditandoIndex(null);
        setTextoEdicao('');
        setCategoriaEdicao('');
        setFotoObrigatoriaEdicao(false);
        show('Pergunta atualizada!', 'success');
      };

      // ============================================
      // EVID√äNCIAS: Upload com compress√£o
      // ============================================
      const handleEvidenciaUpload = async (id, file) => {
        if (!file) return;
        
        const compressImage = (file, maxW=1280, maxH=1280, quality=0.8) => 
          new Promise((resolve, reject) => {
            const img = new Image();
            const reader = new FileReader();
            reader.onload = e => { img.src = e.target.result; };
            img.onload = () => {
              let { width, height } = img;
              const ratio = Math.min(maxW / width, maxH / height, 1);
              const canvas = document.createElement('canvas');
              canvas.width = Math.round(width * ratio);
              canvas.height = Math.round(height * ratio);
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              canvas.toBlob(
                blob => {
                  const fr = new FileReader();
                  fr.onload = ev => resolve(ev.target.result);
                  fr.onerror = reject;
                  fr.readAsDataURL(blob);
                },
                'image/jpeg',
                quality
              );
            };
            img.onerror = reject;
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });

        try {
          show('Processando imagem...', 'success', 1500);
          const base64 = await compressImage(file);
          setEvidencias(ev => ({ ...ev, [id]: base64 }));
          show('Foto anexada com sucesso!', 'success');
        } catch (e) {
          show('Falha ao processar a imagem. Tente outra foto.', 'error');
        }
      };

      // ============================================
      // FLUXO: Iniciar e Finalizar
      // ============================================
      const responderPergunta = (id, resp) => {
        setRespostas({ ...respostas, [id]: resp });
      };

      const requisitosAtendidosParaIniciar = () => {
        if (!lojaNome.trim() || !lojaEndereco.trim()) return false;
        if (!coords) return false;
        if (!dentroDaArea) return false;
        if (gpsConfereEndereco !== true) return false;
        if (perguntas.length === 0) return false;
        return true;
      };

      const iniciarChecklist = () => {
        if (!requisitosAtendidosParaIniciar()) {
          if (gpsConfereEndereco === false) {
            setErroInicio('O endere√ßo GPS n√£o confere com o da loja. Ajuste sua localiza√ß√£o ou verifique o endere√ßo.');
          } else if (!coords) {
            setErroInicio('Capture a localiza√ß√£o GPS antes de iniciar.');
          } else if (!dentroDaArea) {
            setErroInicio('Voc√™ est√° fora da √°rea permitida. Aproxime-se da loja.');
          } else if (!lojaNome.trim() || !lojaEndereco.trim()) {
            setErroInicio('Preencha o nome e endere√ßo da loja.');
          } else if (perguntas.length === 0) {
            setErroInicio('Adicione pelo menos uma pergunta ao checklist.');
          } else {
            setErroInicio('Verifique todos os requisitos antes de iniciar.');
          }
          show('N√£o foi poss√≠vel iniciar. Verifique os requisitos.', 'error', 4000);
          return;
        }
        
        setErroInicio('');
        setChecklistIniciado(true);
        setRespostas({});
        setInicioISO(new Date().toISOString());
        setFimISO(null);
        setPasso(5);
        show('Checklist iniciado! Responda todas as perguntas.', 'success');
      };

      const todasRespondidas = perguntas.every((p) => respostas[p.id]);
      const evidenciasOk = perguntas.every((p) => {
        if (p.fotoObrigatoria) return !!evidencias[p.id];
        return true;
      });

      const finalizarChecklist = () => {
        if (!todasRespondidas) {
          show('Responda todas as perguntas antes de finalizar.', 'error', 3000);
          return;
        }
        if (!evidenciasOk) {
          show('H√° itens com foto obrigat√≥ria sem evid√™ncia anexada.', 'error', 3000);
          return;
        }
        setFimISO(new Date().toISOString());
        setChecklistFinalizado(true);
        setPasso(6);
        show('Checklist finalizado com sucesso!', 'success');
      };

      const calcularNota = () => {
        const total = perguntas.length;
        const pos = perguntas.filter(p => respostas[p.id] === 'sim').length;
        return total > 0 ? ((pos / total) * 10).toFixed(1) : '0.0';
      };

      const reiniciar = () => {
        setChecklistIniciado(false);
        setChecklistFinalizado(false);
        setRespostas({});
        setEvidencias({});
        setCoords(null);
        setEnderecoGPS('');
        setGeoStatus('idle');
        setGeoErro('');
        setDistancia(null);
        setDentroDaArea(false);
        setGpsConfereEndereco(null);
        setInicioISO(null);
        setFimISO(null);
        setAlvoLat('');
        setAlvoLon('');
        setErroInicio('');
        setPasso(1);
        show('Pronto para novo checklist!', 'success');
      };

      // ============================================
      // CSV: Parsing avan√ßado
      // ============================================
      const detectarDelimitador = (text) => {
        const primeiroBloco = text.split(/\r?\n/).slice(0, 5).join('\n');
        const c1 = (primeiroBloco.match(/;/g) || []).length;
        const c2 = (primeiroBloco.match(/,/g) || []).length;
        const c3 = (primeiroBloco.match(/\t/g) || []).length;
        if (c1 >= c2 && c1 >= c3) return ';';
        if (c2 >= c1 && c2 >= c3) return ',';
        return '\t';
      };

      const parseBooleanLoose = (v) => {
        const t = normalizarTexto(v);
        return ['sim','yes','true','1'].includes(t);
      };

      const parseCSVToPerguntas = (text) => {
        const linhas = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        if (linhas.length === 0) return [];
        const delim = detectarDelimitador(text);

        const headerCells = linhas[0].split(delim).map(c => normalizarTexto(c));
        const hasHeader = ['categoria','pergunta','perguntas','foto_obrigatoria','foto obrigatoria','foto-obrigatoria','foto obrigatoria?'].some(h => headerCells.includes(h));

        const out = [];
        if (hasHeader) {
          const idxCategoria = headerCells.findIndex(h => h === 'categoria');
          const idxPergunta = headerCells.findIndex(h => ['pergunta','perguntas'].includes(h));
          const idxFoto = headerCells.findIndex(h => ['foto_obrigatoria','foto obrigatoria','foto-obrigatoria','foto obrigatoria?'].includes(h));
          for (let i = 1; i < linhas.length; i++) {
            const cols = linhas[i].split(delim).map(c => c.trim());
            const texto = idxPergunta >= 0 ? (cols[idxPergunta] || '') : '';
            if (!texto) continue;
            const categoria = idxCategoria >= 0 ? (cols[idxCategoria] || 'Geral') : 'Geral';
            const fotoObrigatoria = idxFoto >= 0 ? parseBooleanLoose(cols[idxFoto] || 'n√£o') : false;
            out.push({ categoria, texto, fotoObrigatoria });
          }
        } else {
          for (const l of linhas) {
            out.push({ categoria: 'Geral', texto: l, fotoObrigatoria: false });
          }
        }
        
        const uniq = [];
        const seen = new Set();
        for (const p of out) {
          const key = normalizarTexto(p.categoria + '__' + p.texto);
          if (!seen.has(key)) { 
            seen.add(key); 
            uniq.push(p); 
          }
        }
        return uniq;
      };

      const handleArquivoCSV = (file) => {
        setUploadErro('');
        if (!file) return;
        const isCSV = file.name.toLowerCase().endsWith('.csv');
        if (!isCSV) {
          setUploadErro('Formato n√£o suportado. Exporte seu Excel como CSV (.csv).');
          show('Formato de arquivo inv√°lido', 'error');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const dados = parseCSVToPerguntas(text);
            if (dados.length === 0) {
              setUploadErro('Nenhuma pergunta v√°lida encontrada no CSV.');
              show('CSV vazio ou inv√°lido', 'error');
              return;
            }
            const novos = dados.map((d, i) => ({
              id: i + 1,
              categoria: d.categoria || 'Geral',
              texto: d.texto,
              fotoObrigatoria: !!d.fotoObrigatoria
            }));
            setPerguntas(novos);
            setRespostas({});
            setEvidencias({});
            show(`${novos.length} perguntas importadas com sucesso!`, 'success');
          } catch (err) {
            setUploadErro('Falha ao processar o CSV. ' + err.message);
            show('Erro ao processar CSV', 'error');
          }
        };
        reader.readAsText(file, 'utf-8');
      };

      const baixarModeloCSV = () => {
        const linhas = [
          'categoria;pergunta;foto_obrigatoria',
          'Seguran√ßa;EPIs conferidos?;sim',
          'Opera√ß√£o;Equipamentos verificados?;nao',
          'Documenta√ß√£o;Documentos atualizados?;nao'
        ];
        const csv = linhas.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'modelo_perguntas_checklist.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        show('Modelo CSV baixado!', 'success');
      };

      // ============================================
      // EXPORTA√á√ÉO: CSV e JSON
      // ============================================
      const exportarPerguntasCSV = () => {
        const header = ['categoria','pergunta','foto_obrigatoria'];
        const linhas = [header.join(';')];
        for (const p of perguntas) {
          linhas.push([
            p.categoria || 'Geral', 
            p.texto.replace(/;/g, ','), 
            p.fotoObrigatoria ? 'sim' : 'nao'
          ].join(';'));
        }
        const blob = new Blob([linhas.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; 
        a.download = 'perguntas_checklist.csv'; 
        document.body.appendChild(a); 
        a.click();
        document.body.removeChild(a); 
        URL.revokeObjectURL(url);
        show('Perguntas exportadas (CSV)!', 'success');
      };

      const exportarPerguntasJSON = () => {
        const blob = new Blob([JSON.stringify(perguntas, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; 
        a.download = 'perguntas_checklist.json'; 
        document.body.appendChild(a); 
        a.click();
        document.body.removeChild(a); 
        URL.revokeObjectURL(url);
        show('Perguntas exportadas (JSON)!', 'success');
      };

      const exportarResultadoCSV = () => {
        const header = ['categoria','pergunta','resposta','tem_foto','loja','endereco','inicio','fim','lat','lon','precisao_m','distancia_m','dentro_area'];
        const linhas = [header.join(';')];
        for (const p of perguntas) {
          const resp = respostas[p.id] || '';
          const foto = evidencias[p.id] ? 'sim' : 'nao';
          linhas.push([
            p.categoria || 'Geral',
            (p.texto || '').replace(/;/g, ','),
            resp,
            foto,
            lojaNome.replace(/;/g, ','),
            lojaEndereco.replace(/;/g, ','),
            inicioISO || '',
            fimISO || '',
            coords?.latitude?.toFixed(6) || '',
            coords?.longitude?.toFixed(6) || '',
            coords?.accuracy ? Math.round(coords.accuracy) : '',
            distancia != null ? Math.round(distancia) : '',
            dentroDaArea ? 'sim' : 'nao'
          ].join(';'));
        }
        const blob = new Blob([linhas.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; 
        a.download = 'resultado_checklist.csv'; 
        document.body.appendChild(a); 
        a.click();
        document.body.removeChild(a); 
        URL.revokeObjectURL(url);
        show('Resultado exportado (CSV)!', 'success');
      };

      // ============================================
      // AGRUPAMENTO POR CATEGORIA
      // ============================================
      const categorias = useMemo(() => {
        const map = new Map();
        for (const p of perguntas) {
          if (!map.has(p.categoria)) map.set(p.categoria, []);
          map.get(p.categoria).push(p);
        }
        return Array.from(map.entries()).sort((a,b) => a[0].localeCompare(b[0]));
      }, [perguntas]);

      // ============================================
      // WIZARD: Atualiza√ß√£o autom√°tica de passos
      // ============================================
      useEffect(() => {
        if (checklistFinalizado) {
          setPasso(6);
        } else if (checklistIniciado) {
          setPasso(5);
        } else if (!lojaNome.trim() || !lojaEndereco.trim()) {
          setPasso(1);
        } else if (!coords || gpsConfereEndereco !== true || !dentroDaArea) {
          setPasso(2);
        } else if (perguntas.length === 0) {
          setPasso(3);
        } else {
          setPasso(4);
        }
      }, [lojaNome, lojaEndereco, coords, gpsConfereEndereco, dentroDaArea, perguntas, checklistIniciado, checklistFinalizado]);

      const passos = [
        { n: 1, label: 'Dados' },
        { n: 2, label: 'GPS' },
        { n: 3, label: 'Perguntas' },
        { n: 4, label: 'Iniciar' },
        { n: 5, label: 'Executar' },
        { n: 6, label: 'Relat√≥rio' },
      ];

      // ============================================
      // RENDERIZA√á√ÉO: Relat√≥rio Final
      // ============================================
      if (checklistFinalizado) {
        const nota = calcularNota();
        const total = perguntas.length;
        const pos = perguntas.filter(p => respostas[p.id] === 'sim').length;
        const duracao = inicioISO && fimISO ? duracaoHumana(new Date(fimISO) - new Date(inicioISO)) : '';

        return (
          <div className="min-h-screen p-4 print:bg-white print:p-0">
            <Toast />
            <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 print:shadow-none">
              <WizardSteps currentStep={passo} steps={passos} />
              
              <div className="text-center mb-8">
                <h1 className="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">
                  <i className="fas fa-file-alt mr-3 text-blue-600"></i>
                  Relat√≥rio do Checklist
                </h1>
                <p className="text-gray-600">Auditoria conclu√≠da com sucesso</p>
              </div>

              {/* Dados da Loja */}
              <div className="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-200">
                <h3 className="font-bold text-lg mb-3 text-blue-800 flex items-center gap-2">
                  <i className="fas fa-store"></i>
                  Dados da Loja
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                  <div>
                    <span className="font-semibold">Nome:</span> {lojaNome}
                  </div>
                  <div>
                    <span className="font-semibold">Endere√ßo:</span> {lojaEndereco}
                  </div>
                </div>
              </div>

              {/* Informa√ß√µes de Tempo e GPS */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div className="bg-gray-50 p-5 rounded-xl border">
                  <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i className="fas fa-clock text-purple-600"></i>
                    Tempo de Execu√ß√£o
                  </h4>
                  <div className="text-sm text-gray-700 space-y-2">
                    <div><span className="font-semibold">In√≠cio:</span> {formatarDataHora(inicioISO)}</div>
                    <div><span className="font-semibold">T√©rmino:</span> {formatarDataHora(fimISO)}</div>
                    <div><span className="font-semibold">Dura√ß√£o:</span> {duracao}</div>
                  </div>
                </div>

                <div className="bg-gray-50 p-5 rounded-xl border">
                  <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i className="fas fa-map-marker-alt text-red-600"></i>
                    Localiza√ß√£o GPS
                  </h4>
                  {coords && (
                    <div className="text-sm text-gray-700 space-y-2">
                      <div className="break-all">
                        <span className="font-semibold">Coordenadas:</span> {coords.latitude.toFixed(6)}, {coords.longitude.toFixed(6)}
                      </div>
                      {coords.accuracy && (
                        <div><span className="font-semibold">Precis√£o:</span> ¬±{Math.round(coords.accuracy)} m</div>
                      )}
                      {distancia != null && (
                        <div>
                          <span className="font-semibold">Dist√¢ncia:</span> {Math.round(distancia)} m
                          <span className={'ml-2 badge ' + (dentroDaArea ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>
                            {dentroDaArea ? 'Dentro da √°rea' : 'Fora da √°rea'}
                          </span>
                        </div>
                      )}
                      {enderecoGPS && (
                        <div className="break-words pt-2 border-t">
                          <span className="font-semibold">Endere√ßo GPS:</span> {enderecoGPS}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Nota Final */}
              <div className="bg-gradient-to-r from-green-400 to-emerald-500 rounded-xl p-6 mb-6 text-center text-white shadow-lg">
                <h2 className="text-5xl sm:text-6xl font-bold mb-2">{nota}</h2>
                <p className="text-lg">Nota Final</p>
                <p className="text-sm opacity-90 mt-1">{pos} de {total} respostas positivas ({((pos/total)*100).toFixed(0)}%)</p>
              </div>

              {/* Resumo por Categoria */}
              <div className="mb-6">
                <h3 className="font-bold text-xl mb-4 text-gray-800">
                  <i className="fas fa-list-check mr-2"></i>
                  Resumo por Categoria
                </h3>
                <div className="space-y-4">
                  {categorias.map(([cat, itens]) => {
                    const catPos = itens.filter(p => respostas[p.id] === 'sim').length;
                    const catTotal = itens.length;
                    const catPercent = ((catPos / catTotal) * 100).toFixed(0);
                    
                    return (
                      <div key={cat} className="card border overflow-hidden">
                        <div className="px-4 py-3 bg-gradient-to-r from-gray-100 to-gray-50 border-b flex items-center justify-between">
                          <span className="font-bold text-gray-800">{cat}</span>
                          <span className="text-sm text-gray-600">{catPos}/{catTotal} ({catPercent}%)</span>
                        </div>
                        <div className="p-4 space-y-3">
                          {itens.map((p) => (
                            <div key={p.id} className="bg-gray-50 p-4 rounded-lg border">
                              <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                                <div className="flex-1">
                                  <div className="text-sm font-semibold mb-2 break-words text-gray-800">
                                    {p.texto}
                                  </div>
                                  <div className="flex items-center gap-3 flex-wrap">
                                    <span className={'badge text-sm ' + (respostas[p.id] === 'sim' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>
                                      {respostas[p.id] === 'sim' ? '‚úì SIM' : '‚úó N√ÉO'}
                                    </span>
                                    {p.fotoObrigatoria && (
                                      <span className="badge bg-yellow-100 text-yellow-700">
                                        <i className="fas fa-camera mr-1"></i>Foto obrigat√≥ria
                                      </span>
                                    )}
                                  </div>
                                </div>
                                <div className="w-full lg:w-48 text-center">
                                  {evidencias[p.id] ? (
                                    <img 
                                      src={evidencias[p.id]} 
                                      alt={'Evid√™ncia ' + p.id} 
                                      className="w-full h-32 object-cover rounded-lg border-2 border-gray-200 shadow-sm mx-auto" 
                                    />
                                  ) : (
                                    <div className="w-full h-32 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center">
                                      <span className="text-xs text-gray-400">Sem evid√™ncia</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Bot√µes de A√ß√£o */}
              <div className="flex flex-col sm:flex-row gap-3 no-print">
                <button 
                  onClick={() => window.print()} 
                  className="btn flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition shadow-md"
                >
                  <i className="fas fa-print"></i>
                  Imprimir / Salvar PDF
                </button>
                <button 
                  onClick={exportarResultadoCSV} 
                  className="btn flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition shadow-md"
                >
                  <i className="fas fa-file-csv"></i>
                  Exportar CSV
                </button>
                <button 
                  onClick={reiniciar} 
                  className="btn flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition shadow-md"
                >
                  <i className="fas fa-redo"></i>
                  Novo Checklist
                </button>
              </div>
            </div>
          </div>
        );
      }

      // ============================================
      // RENDERIZA√á√ÉO: Checklist em Andamento
      // ============================================
      if (checklistIniciado) {
        const respondidas = perguntas.filter(p => respostas[p.id]).length;
        const progresso = ((respondidas / perguntas.length) * 100).toFixed(0);
        
        return (
          <div className="min-h-screen p-4">
            <Toast />
            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-8">
              <WizardSteps currentStep={passo} steps={passos} />
              
              <div className="text-center mb-6">
                <h1 className="text-2xl sm:text-3xl font-bold text-purple-600 mb-2">
                  <i className="fas fa-clipboard-check mr-2"></i>
                  Checklist em Andamento
                </h1>
                <p className="text-gray-600">Responda todas as perguntas e anexe as evid√™ncias</p>
              </div>

              {/* Informa√ß√µes da Loja */}
              <div className="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                <h3 className="font-bold text-sm mb-2 text-blue-800 flex items-center gap-2">
                  <i className="fas fa-store"></i>
                  {lojaNome}
                </h3>
                <div className="text-xs text-gray-700">{lojaEndereco}</div>
              </div>

              {/* Barra de Progresso */}
              <div className="mb-6 bg-gray-100 p-4 rounded-xl">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-semibold text-gray-700">Progresso</span>
                  <span className="text-sm font-bold text-purple-600">{respondidas}/{perguntas.length} ({progresso}%)</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                  <div 
                    className="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-300"
                    style={{ width: progresso + '%' }}
                  ></div>
                </div>
              </div>

              {/* Perguntas por Categoria */}
              <div className="space-y-6 mb-6">
                {categorias.map(([cat, itens]) => (
                  <div key={cat} className="card border overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-purple-100 to-pink-100 border-b">
                      <span className="font-bold text-purple-800">{cat}</span>
                    </div>
                    <div className="p-4 space-y-4">
                      {itens.map((p) => (
                        <div key={p.id} className="bg-gray-50 p-4 rounded-xl border-2 border-gray-200 hover:border-purple-300 transition">
                          <p className="font-semibold mb-3 text-sm sm:text-base break-words text-gray-800">
                            {p.texto}
                          </p>
                          
                          {/* Bot√µes SIM/N√ÉO */}
                          <div className="flex flex-col gap-3">
                            <div className="flex gap-3">
                              <button
                                onClick={() => responderPergunta(p.id, 'sim')}
                                aria-pressed={respostas[p.id] === 'sim'}
                                className={'btn flex-1 py-3 rounded-lg font-bold transition text-sm sm:text-base ' + (
                                  respostas[p.id] === 'sim' 
                                    ? 'bg-green-500 text-white shadow-lg' 
                                    : 'bg-gray-200 text-gray-700 hover:bg-green-100'
                                )}
                              >
                                <i className="fas fa-check"></i>
                                SIM
                              </button>
                              <button
                                onClick={() => responderPergunta(p.id, 'nao')}
                                aria-pressed={respostas[p.id] === 'nao'}
                                className={'btn flex
